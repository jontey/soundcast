<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soundcast - Room Listener</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .title {
      font-size: 32px;
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .room-name {
      font-size: 18px;
      color: #718096;
      margin-bottom: 5px;
    }

    .room-slug {
      font-size: 14px;
      color: #a0aec0;
      font-family: monospace;
    }

    .status {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .status.disconnected {
      background: #fff5f5;
      color: #c53030;
    }

    .status.connecting {
      background: #fffaf0;
      color: #c05621;
    }

    .status.connected {
      background: #f0fff4;
      color: #22543d;
    }

    .status.listening {
      background: #ebf8ff;
      color: #2c5282;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .info-box {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #4a5568;
    }

    .info-label {
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .info-value {
      font-family: monospace;
      color: #667eea;
      word-break: break-all;
    }

    .player-card {
      background: #f7fafc;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
    }

    .player-icon {
      font-size: 80px;
      margin-bottom: 15px;
    }

    .player-status {
      font-size: 16px;
      color: #4a5568;
      margin-bottom: 15px;
    }

    .volume-control {
      margin-top: 20px;
    }

    .volume-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }

    .volume-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      border: none;
    }

    .volume-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
      color: #718096;
    }

    .error {
      background: #fff5f5;
      border-left: 4px solid #f56565;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      color: #742a2a;
      display: none;
    }

    .interpreter-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
      margin-top: 10px;
      font-size: 14px;
      font-weight: bold;
    }

    .ice-servers {
      max-height: 100px;
      overflow-y: auto;
      background: #edf2f7;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      font-family: monospace;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">üéß Listener</div>
      <div class="room-name" id="roomName">Loading room...</div>
      <div class="room-slug" id="roomSlug"></div>
    </div>

    <div id="status" class="status disconnected">
      Connecting to room...
    </div>

    <div id="errorMessage" class="error"></div>

    <div id="configInfo" class="info-box" style="display: none;">
      <div class="info-label">SFU Configuration</div>
      <div class="info-value" id="sfuUrl"></div>
      <div class="info-label" style="margin-top: 10px;">Network Type</div>
      <div class="info-value" id="networkType"></div>
      <div class="info-label" style="margin-top: 10px;">ICE Servers</div>
      <div class="ice-servers" id="iceServers"></div>
      <div id="interpreterInfo" style="display: none;">
        <div class="interpreter-badge">
          üåê Interpreter Mode: <span id="targetLanguage"></span>
        </div>
      </div>
    </div>

    <div class="player-card">
      <div class="player-icon" id="playerIcon">üîá</div>
      <div class="player-status" id="playerStatus">Waiting for audio stream...</div>

      <div class="volume-control" id="volumeControl" style="display: none;">
        <div class="volume-label">
          <span>Volume</span>
          <span id="volumeValue">100%</span>
        </div>
        <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
      </div>
    </div>

    <audio id="audioPlayer" autoplay></audio>
  </div>

  <script src="/js/bundles/mediasoup-client.js"></script>
  <script>
    // Extract room slug from URL path (/room/:slug/listen)
    const pathParts = window.location.pathname.split('/');
    const roomSlug = pathParts[2];

    // Check if this is an interpreter connection (has ?token parameter)
    const urlParams = new URLSearchParams(window.location.search);
    const interpreterToken = urlParams.get('token');
    const isInterpreter = !!interpreterToken;

    if (!roomSlug) {
      showError('Invalid room URL');
      throw new Error('Room slug not found in URL');
    }

    document.getElementById('roomSlug').textContent = roomSlug;
    document.getElementById('roomName').textContent = `Room: ${roomSlug}`;

    // WebSocket and WebRTC state
    let ws = null;
    let roomConfig = null;
    let audioElement = document.getElementById('audioPlayer');

    // Status management
    function setStatus(message, className) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${className}`;
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = '‚ùå ' + message;
      el.style.display = 'block';
    }

    // Connect to room WebSocket
    function connectToRoom() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      let wsUrl;

      if (isInterpreter) {
        wsUrl = `${protocol}//${window.location.host}/ws/room/${roomSlug}/interpret?token=${interpreterToken}`;
        setStatus('Connecting as interpreter...', 'connecting');
      } else {
        wsUrl = `${protocol}//${window.location.host}/ws/room/${roomSlug}/listen`;
        setStatus('Connecting to room...', 'connecting');
      }

      console.log('Connecting to:', wsUrl);

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocket connected');
        setStatus('Connected, waiting for configuration...', 'connected');
      };

      ws.onmessage = async (event) => {
        try {
          const message = JSON.parse(event.data);
          console.log('Received message:', message);

          if (message.type === 'config') {
            handleRoomConfig(message.data);
          } else if (message.type === 'error') {
            showError(message.data.message);
            setStatus('Error: ' + message.data.message, 'disconnected');
          }
        } catch (error) {
          console.error('Error handling message:', error);
          showError('Failed to handle server message');
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        showError('WebSocket connection error');
        setStatus('Connection error', 'disconnected');
      };

      ws.onclose = () => {
        console.log('WebSocket closed');
        setStatus('Disconnected from room', 'disconnected');
        document.getElementById('playerIcon').textContent = 'üîá';
        document.getElementById('playerStatus').textContent = 'Disconnected';
      };
    }

    // Handle room configuration from server
    function handleRoomConfig(config) {
      console.log('Room config received:', config);
      roomConfig = config;

      // Display config info
      document.getElementById('sfuUrl').textContent = config.sfuUrl;
      document.getElementById('networkType').textContent = config.isLocalOnly ? 'Local Network' : 'Public Network';

      // Display ICE servers
      const iceServersEl = document.getElementById('iceServers');
      iceServersEl.textContent = JSON.stringify(config.iceServers, null, 2);

      // If interpreter, show target language
      if (config.targetLanguage) {
        document.getElementById('targetLanguage').textContent = config.targetLanguage.toUpperCase();
        document.getElementById('interpreterInfo').style.display = 'block';
      }

      document.getElementById('configInfo').style.display = 'block';

      // For now, we simulate listening
      // In a full implementation, you would:
      // 1. Create a new WebSocket connection to config.sfuUrl
      // 2. Create RTCPeerConnection with config.iceServers
      // 3. Implement the full WebRTC signaling protocol
      setStatus('Ready to receive audio', 'connected');
      document.getElementById('playerIcon').textContent = 'üéß';
      document.getElementById('playerStatus').textContent = 'Waiting for publisher...';

      showError(`Note: Full WebRTC implementation would connect to ${config.sfuUrl}`);
    }

    // Volume control
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');

    volumeSlider.addEventListener('input', (e) => {
      const volume = e.target.value;
      audioElement.volume = volume / 100;
      volumeValue.textContent = volume + '%';
    });

    // When audio starts playing
    audioElement.addEventListener('playing', () => {
      setStatus('üî¥ Listening to audio', 'listening');
      document.getElementById('playerIcon').textContent = 'üîä';
      document.getElementById('playerStatus').textContent = 'Audio playing';
      document.getElementById('volumeControl').style.display = 'block';
    });

    // When audio is paused/stopped
    audioElement.addEventListener('pause', () => {
      setStatus('Ready to receive audio', 'connected');
      document.getElementById('playerIcon').textContent = 'üéß';
      document.getElementById('playerStatus').textContent = 'Audio paused';
    });

    // Initialize
    connectToRoom();
  </script>
</body>
</html>
