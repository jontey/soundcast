var Bi=Object.create;var pr=Object.defineProperty;var Ui=Object.getOwnPropertyDescriptor;var Vi=Object.getOwnPropertyNames;var Hi=Object.getPrototypeOf,Gi=Object.prototype.hasOwnProperty;var ns=r=>{throw TypeError(r)};var Qi=(r,s,e)=>s in r?pr(r,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[s]=e;var x=(r,s)=>()=>(s||r((s={exports:{}}).exports,s),s.exports);var Ki=(r,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of Vi(s))!Gi.call(r,i)&&i!==e&&pr(r,i,{get:()=>s[i],enumerable:!(t=Ui(s,i))||t.enumerable});return r};var Wi=(r,s,e)=>(e=r!=null?Bi(Hi(r)):{},Ki(s||!r||!r.__esModule?pr(e,"default",{value:r,enumerable:!0}):e,r));var c=(r,s,e)=>Qi(r,typeof s!="symbol"?s+"":s,e),as=(r,s,e)=>s.has(r)||ns("Cannot "+e);var D=(r,s,e)=>(as(r,s,"read from private field"),e?e.call(r):s.get(r)),z=(r,s,e)=>s.has(r)?ns("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(r):s.set(r,e),N=(r,s,e,t)=>(as(r,s,"write to private field"),t?t.call(r,e):s.set(r,e),e);var cs=x((Vo,os)=>{var qe=1e3,ze=qe*60,$e=ze*60,Se=$e*24,Ji=Se*7,Yi=Se*365.25;os.exports=function(r,s){s=s||{};var e=typeof r;if(e==="string"&&r.length>0)return Zi(r);if(e==="number"&&isFinite(r))return s.long?en(r):Xi(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Zi(r){if(r=String(r),!(r.length>100)){var s=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(s){var e=parseFloat(s[1]),t=(s[2]||"ms").toLowerCase();switch(t){case"years":case"year":case"yrs":case"yr":case"y":return e*Yi;case"weeks":case"week":case"w":return e*Ji;case"days":case"day":case"d":return e*Se;case"hours":case"hour":case"hrs":case"hr":case"h":return e*$e;case"minutes":case"minute":case"mins":case"min":case"m":return e*ze;case"seconds":case"second":case"secs":case"sec":case"s":return e*qe;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:return}}}}function Xi(r){var s=Math.abs(r);return s>=Se?Math.round(r/Se)+"d":s>=$e?Math.round(r/$e)+"h":s>=ze?Math.round(r/ze)+"m":s>=qe?Math.round(r/qe)+"s":r+"ms"}function en(r){var s=Math.abs(r);return s>=Se?Dt(r,s,Se,"day"):s>=$e?Dt(r,s,$e,"hour"):s>=ze?Dt(r,s,ze,"minute"):s>=qe?Dt(r,s,qe,"second"):r+" ms"}function Dt(r,s,e,t){var i=s>=e*1.5;return Math.round(r/e)+" "+t+(i?"s":"")}});var ps=x((Ho,ds)=>{function tn(r){e.debug=e,e.default=e,e.coerce=l,e.disable=a,e.enable=i,e.enabled=o,e.humanize=cs(),e.destroy=u,Object.keys(r).forEach(d=>{e[d]=r[d]}),e.names=[],e.skips=[],e.formatters={};function s(d){let p=0;for(let h=0;h<d.length;h++)p=(p<<5)-p+d.charCodeAt(h),p|=0;return e.colors[Math.abs(p)%e.colors.length]}e.selectColor=s;function e(d){let p,h=null,m,g;function v(...f){if(!v.enabled)return;let _=v,T=Number(new Date),P=T-(p||T);_.diff=P,_.prev=p,_.curr=T,p=T,f[0]=e.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let L=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(k,j)=>{if(k==="%%")return"%";L++;let be=e.formatters[j];if(typeof be=="function"){let fe=f[L];k=be.call(_,fe),f.splice(L,1),L--}return k}),e.formatArgs.call(_,f),(_.log||e.log).apply(_,f)}return v.namespace=d,v.useColors=e.useColors(),v.color=e.selectColor(d),v.extend=t,v.destroy=e.destroy,Object.defineProperty(v,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(m!==e.namespaces&&(m=e.namespaces,g=e.enabled(d)),g),set:f=>{h=f}}),typeof e.init=="function"&&e.init(v),v}function t(d,p){let h=e(this.namespace+(typeof p>"u"?":":p)+d);return h.log=this.log,h}function i(d){e.save(d),e.namespaces=d,e.names=[],e.skips=[];let p=(typeof d=="string"?d:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let h of p)h[0]==="-"?e.skips.push(h.slice(1)):e.names.push(h)}function n(d,p){let h=0,m=0,g=-1,v=0;for(;h<d.length;)if(m<p.length&&(p[m]===d[h]||p[m]==="*"))p[m]==="*"?(g=m,v=h,m++):(h++,m++);else if(g!==-1)m=g+1,v++,h=v;else return!1;for(;m<p.length&&p[m]==="*";)m++;return m===p.length}function a(){let d=[...e.names,...e.skips.map(p=>"-"+p)].join(",");return e.enable(""),d}function o(d){for(let p of e.skips)if(n(d,p))return!1;for(let p of e.names)if(n(d,p))return!0;return!1}function l(d){return d instanceof Error?d.stack||d.message:d}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}ds.exports=tn});var ut=x((H,Pt)=>{H.formatArgs=sn;H.save=nn;H.load=an;H.useColors=rn;H.storage=on();H.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();H.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function rn(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function sn(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Pt.exports.humanize(this.diff),!this.useColors)return;let s="color: "+this.color;r.splice(1,0,s,"color: inherit");let e=0,t=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(e++,i==="%c"&&(t=e))}),r.splice(t,0,s)}H.log=console.debug||console.log||(()=>{});function nn(r){try{r?H.storage.setItem("debug",r):H.storage.removeItem("debug")}catch{}}function an(){let r;try{r=H.storage.getItem("debug")||H.storage.getItem("DEBUG")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function on(){try{return localStorage}catch{}}Pt.exports=ps()(H);var{formatters:cn}=Pt.exports;cn.j=function(r){try{return JSON.stringify(r)}catch(s){return"[UnexpectedJSONParseError]: "+s.message}}});var us=x(ls=>{"use strict";Object.defineProperty(ls,"__esModule",{value:!0})});var U=x(Lt=>{"use strict";Object.defineProperty(Lt,"__esModule",{value:!0});Lt.Logger=void 0;var Be=ut(),Ue="mediasoup-client",lr=class{constructor(s){c(this,"_debug");c(this,"_warn");c(this,"_error");s?(this._debug=(0,Be.default)(`${Ue}:${s}`),this._warn=(0,Be.default)(`${Ue}:WARN:${s}`),this._error=(0,Be.default)(`${Ue}:ERROR:${s}`)):(this._debug=(0,Be.default)(Ue),this._warn=(0,Be.default)(`${Ue}:WARN`),this._error=(0,Be.default)(`${Ue}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};Lt.Logger=lr});var Cs=x((Wo,ur)=>{"use strict";var Ve=typeof Reflect=="object"?Reflect:null,hs=Ve&&typeof Ve.apply=="function"?Ve.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)},It;Ve&&typeof Ve.ownKeys=="function"?It=Ve.ownKeys:Object.getOwnPropertySymbols?It=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:It=function(s){return Object.getOwnPropertyNames(s)};function dn(r){console&&console.warn&&console.warn(r)}var fs=Number.isNaN||function(s){return s!==s};function I(){I.init.call(this)}ur.exports=I;ur.exports.once=hn;I.EventEmitter=I;I.prototype._events=void 0;I.prototype._eventsCount=0;I.prototype._maxListeners=void 0;var ms=10;function Mt(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(I,"defaultMaxListeners",{enumerable:!0,get:function(){return ms},set:function(r){if(typeof r!="number"||r<0||fs(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");ms=r}});I.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};I.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||fs(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function gs(r){return r._maxListeners===void 0?I.defaultMaxListeners:r._maxListeners}I.prototype.getMaxListeners=function(){return gs(this)};I.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var i=s==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=n[s];if(l===void 0)return!1;if(typeof l=="function")hs(l,this,e);else for(var u=l.length,d=ys(l,u),t=0;t<u;++t)hs(d[t],this,e);return!0};function _s(r,s,e,t){var i,n,a;if(Mt(e),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",s,e.listener?e.listener:e),n=r._events),a=n[s]),a===void 0)a=n[s]=e,++r._eventsCount;else if(typeof a=="function"?a=n[s]=t?[e,a]:[a,e]:t?a.unshift(e):a.push(e),i=gs(r),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=s,o.count=a.length,dn(o)}return r}I.prototype.addListener=function(s,e){return _s(this,s,e,!1)};I.prototype.on=I.prototype.addListener;I.prototype.prependListener=function(s,e){return _s(this,s,e,!0)};function pn(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function vs(r,s,e){var t={fired:!1,wrapFn:void 0,target:r,type:s,listener:e},i=pn.bind(t);return i.listener=e,t.wrapFn=i,i}I.prototype.once=function(s,e){return Mt(e),this.on(s,vs(this,s,e)),this};I.prototype.prependOnceListener=function(s,e){return Mt(e),this.prependListener(s,vs(this,s,e)),this};I.prototype.removeListener=function(s,e){var t,i,n,a,o;if(Mt(e),i=this._events,i===void 0)return this;if(t=i[s],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete i[s],i.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(n=-1,a=t.length-1;a>=0;a--)if(t[a]===e||t[a].listener===e){o=t[a].listener,n=a;break}if(n<0)return this;n===0?t.shift():ln(t,n),t.length===1&&(i[s]=t[0]),i.removeListener!==void 0&&this.emit("removeListener",s,o||e)}return this};I.prototype.off=I.prototype.removeListener;I.prototype.removeAllListeners=function(s){var e,t,i;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var n=Object.keys(t),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[s],typeof e=="function")this.removeListener(s,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(s,e[i]);return this};function ws(r,s,e){var t=r._events;if(t===void 0)return[];var i=t[s];return i===void 0?[]:typeof i=="function"?e?[i.listener||i]:[i]:e?un(i):ys(i,i.length)}I.prototype.listeners=function(s){return ws(this,s,!0)};I.prototype.rawListeners=function(s){return ws(this,s,!1)};I.listenerCount=function(r,s){return typeof r.listenerCount=="function"?r.listenerCount(s):bs.call(r,s)};I.prototype.listenerCount=bs;function bs(r){var s=this._events;if(s!==void 0){var e=s[r];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}I.prototype.eventNames=function(){return this._eventsCount>0?It(this._events):[]};function ys(r,s){for(var e=new Array(s),t=0;t<s;++t)e[t]=r[t];return e}function ln(r,s){for(;s+1<r.length;s++)r[s]=r[s+1];r.pop()}function un(r){for(var s=new Array(r.length),e=0;e<s.length;++e)s[e]=r[e].listener||r[e];return s}function hn(r,s){return new Promise(function(e,t){function i(a){r.removeListener(s,n),t(a)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),e([].slice.call(arguments))}Ss(r,s,n,{once:!0}),s!=="error"&&mn(r,i,{once:!0})})}function mn(r,s,e){typeof r.on=="function"&&Ss(r,"error",s,e)}function Ss(r,s,e,t){if(typeof r.on=="function")t.once?r.once(s,e):r.on(s,e);else if(typeof r.addEventListener=="function")r.addEventListener(s,function i(n){t.once&&r.removeEventListener(s,i),e(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var G=x(Ot=>{"use strict";Object.defineProperty(Ot,"__esModule",{value:!0});Ot.EnhancedEventEmitter=void 0;var fn=Cs(),gn=U(),_n=new gn.Logger("EnhancedEventEmitter"),hr=class extends fn.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}close(){super.removeAllListeners()}emit(s,...e){return super.emit(s,...e)}safeEmit(s,...e){try{return super.emit(s,...e)}catch(t){_n.error("safeEmit() | event listener threw an error [eventName:%s]:%o",s,t);try{super.emit("listenererror",s,t)}catch{}return!!super.listenerCount(s)}}on(s,e){return super.on(s,e),this}off(s,e){return super.off(s,e),this}addListener(s,e){return super.on(s,e),this}prependListener(s,e){return super.prependListener(s,e),this}once(s,e){return super.once(s,e),this}prependOnceListener(s,e){return super.prependOnceListener(s,e),this}removeListener(s,e){return super.off(s,e),this}removeAllListeners(s){return super.removeAllListeners(s),this}listenerCount(s){return super.listenerCount(s)}listeners(s){return super.listeners(s)}rawListeners(s){return super.rawListeners(s)}};Ot.EnhancedEventEmitter=hr});var W=x(He=>{"use strict";Object.defineProperty(He,"__esModule",{value:!0});He.InvalidStateError=He.UnsupportedError=void 0;var mr=class r extends Error{constructor(s){super(s),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,r):this.stack=new Error(s).stack}};He.UnsupportedError=mr;var fr=class r extends Error{constructor(s){super(s),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,r):this.stack=new Error(s).stack}};He.InvalidStateError=fr});var Ce=x(ht=>{"use strict";Object.defineProperty(ht,"__esModule",{value:!0});ht.clone=vn;ht.generateRandomNumber=wn;ht.deepFreeze=Rs;function vn(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}function wn(){return Math.round(Math.random()*1e7)}function Rs(r){let s=Reflect.ownKeys(r);for(let e of s){let t=r[e];(t&&typeof t=="object"||typeof t=="function")&&Rs(t)}return Object.freeze(r)}});var Es=x(Nt=>{"use strict";Object.defineProperty(Nt,"__esModule",{value:!0});Nt.Logger=void 0;var Ge=ut(),Qe="h264-profile-level-id",gr=class{constructor(s){c(this,"_debug");c(this,"_warn");c(this,"_error");s?(this._debug=(0,Ge.default)(`${Qe}:${s}`),this._warn=(0,Ge.default)(`${Qe}:WARN:${s}`),this._error=(0,Ge.default)(`${Qe}:ERROR:${s}`)):(this._debug=(0,Ge.default)(Qe),this._warn=(0,Ge.default)(`${Qe}:WARN`),this._error=(0,Ge.default)(`${Qe}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};Nt.Logger=gr});var Ls=x($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.ProfileLevelId=$.Level=$.Profile=void 0;$.parseProfileLevelId=Ds;$.profileLevelIdToString=Ps;$.profileToString=Cn;$.levelToString=Rn;$.parseSdpProfileLevelId=Re;$.isSameProfile=En;$.isSameProfileAndLevel=Tn;$.generateProfileLevelIdStringForAnswer=xn;$.supportedLevel=kn;var bn=Es(),Z=new bn.Logger,M;(function(r){r[r.ConstrainedBaseline=1]="ConstrainedBaseline",r[r.Baseline=2]="Baseline",r[r.Main=3]="Main",r[r.ConstrainedHigh=4]="ConstrainedHigh",r[r.High=5]="High",r[r.PredictiveHigh444=6]="PredictiveHigh444"})(M||($.Profile=M={}));var w;(function(r){r[r.L1_b=0]="L1_b",r[r.L1=10]="L1",r[r.L1_1=11]="L1_1",r[r.L1_2=12]="L1_2",r[r.L1_3=13]="L1_3",r[r.L2=20]="L2",r[r.L2_1=21]="L2_1",r[r.L2_2=22]="L2_2",r[r.L3=30]="L3",r[r.L3_1=31]="L3_1",r[r.L3_2=32]="L3_2",r[r.L4=40]="L4",r[r.L4_1=41]="L4_1",r[r.L4_2=42]="L4_2",r[r.L5=50]="L5",r[r.L5_1=51]="L5_1",r[r.L5_2=52]="L5_2"})(w||($.Level=w={}));var Ke=class{constructor(s,e){c(this,"profile");c(this,"level");this.profile=s,this.level=e}};$.ProfileLevelId=Ke;var yn=new Ke(M.ConstrainedBaseline,w.L3_1),J=class{constructor(s){c(this,"mask");c(this,"masked_value");this.mask=~xs("x",s),this.masked_value=xs("1",s)}isMatch(s){return this.masked_value===(s&this.mask)}},Y=class{constructor(s,e,t){c(this,"profile_idc");c(this,"profile_iop");c(this,"profile");this.profile_idc=s,this.profile_iop=e,this.profile=t}},Sn=[new Y(66,new J("x1xx0000"),M.ConstrainedBaseline),new Y(77,new J("1xxx0000"),M.ConstrainedBaseline),new Y(88,new J("11xx0000"),M.ConstrainedBaseline),new Y(66,new J("x0xx0000"),M.Baseline),new Y(88,new J("10xx0000"),M.Baseline),new Y(77,new J("0x0x0000"),M.Main),new Y(100,new J("00000000"),M.High),new Y(100,new J("00001100"),M.ConstrainedHigh),new Y(244,new J("00000000"),M.PredictiveHigh444)],Ts=[{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:w.L1},{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:w.L1_b},{max_macroblocks_per_second:3e3,max_macroblock_frame_size:396,level:w.L1_1},{max_macroblocks_per_second:6e3,max_macroblock_frame_size:396,level:w.L1_2},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:w.L1_3},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:w.L2},{max_macroblocks_per_second:19800,max_macroblock_frame_size:792,level:w.L2_1},{max_macroblocks_per_second:20250,max_macroblock_frame_size:1620,level:w.L2_2},{max_macroblocks_per_second:40500,max_macroblock_frame_size:1620,level:w.L3},{max_macroblocks_per_second:108e3,max_macroblock_frame_size:3600,level:w.L3_1},{max_macroblocks_per_second:216e3,max_macroblock_frame_size:5120,level:w.L3_2},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:w.L4},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:w.L4_1},{max_macroblocks_per_second:522240,max_macroblock_frame_size:8704,level:w.L4_2},{max_macroblocks_per_second:589824,max_macroblock_frame_size:22080,level:w.L5},{max_macroblocks_per_second:983040,max_macroblock_frame_size:36864,level:w.L5_1},{max_macroblocks_per_second:2073600,max_macroblock_frame_size:36864,level:w.L5_2}];function Ds(r){if(typeof r!="string"||r.length!==6)return;let e=parseInt(r,16);if(e===0)return;let t=e&255,i=e>>8&255,n=e>>16&255,a;switch(t){case w.L1_1:{a=(i&16)!==0?w.L1_b:w.L1_1;break}case w.L1:case w.L1_2:case w.L1_3:case w.L2:case w.L2_1:case w.L2_2:case w.L3:case w.L3_1:case w.L3_2:case w.L4:case w.L4_1:case w.L4_2:case w.L5:case w.L5_1:case w.L5_2:{a=t;break}default:{Z.warn(`parseProfileLevelId() | unrecognized level_idc [str:${r}, level_idc:${t}]`);return}}for(let o of Sn)if(n===o.profile_idc&&o.profile_iop.isMatch(i))return Z.debug(`parseProfileLevelId() | result [str:${r}, profile:${o.profile}, level:${a}]`),new Ke(o.profile,a);Z.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${r}, profile_idc:${n}, profile_iop:${i}]`)}function Ps(r){if(r.level==w.L1_b)switch(r.profile){case M.ConstrainedBaseline:return"42f00b";case M.Baseline:return"42100b";case M.Main:return"4d100b";default:{Z.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${r.profile}`);return}}let s;switch(r.profile){case M.ConstrainedBaseline:{s="42e0";break}case M.Baseline:{s="4200";break}case M.Main:{s="4d00";break}case M.ConstrainedHigh:{s="640c";break}case M.High:{s="6400";break}case M.PredictiveHigh444:{s="f400";break}default:{Z.warn(`profileLevelIdToString() | unrecognized profile ${r.profile}`);return}}let e=r.level.toString(16);return e.length===1&&(e=`0${e}`),`${s}${e}`}function Cn(r){switch(r){case M.ConstrainedBaseline:return"ConstrainedBaseline";case M.Baseline:return"Baseline";case M.Main:return"Main";case M.ConstrainedHigh:return"ConstrainedHigh";case M.High:return"High";case M.PredictiveHigh444:return"PredictiveHigh444";default:{Z.warn(`profileToString() | unrecognized profile ${r}`);return}}}function Rn(r){switch(r){case w.L1_b:return"1b";case w.L1:return"1";case w.L1_1:return"1.1";case w.L1_2:return"1.2";case w.L1_3:return"1.3";case w.L2:return"2";case w.L2_1:return"2.1";case w.L2_2:return"2.2";case w.L3:return"3";case w.L3_1:return"3.1";case w.L3_2:return"3.2";case w.L4:return"4";case w.L4_1:return"4.1";case w.L4_2:return"4.2";case w.L5:return"5";case w.L5_1:return"5.1";case w.L5_2:return"5.2";default:{Z.warn(`levelToString() | unrecognized level ${r}`);return}}}function Re(r={}){let s=r["profile-level-id"];return s?Ds(s):yn}function En(r={},s={}){let e=Re(r),t=Re(s);return!!(e&&t&&e.profile===t.profile)}function Tn(r={},s={}){let e=Re(r),t=Re(s);return!!(e&&t&&e.profile===t.profile&&e.level==t.level)}function xn(r={},s={}){if(!r["profile-level-id"]&&!s["profile-level-id"]){Z.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}let e=Re(r),t=Re(s);if(!e)throw new TypeError("invalid local_profile_level_id");if(!t)throw new TypeError("invalid remote_profile_level_id");if(e.profile!==t.profile)throw new TypeError("H264 Profile mismatch");let i=ks(r)&&ks(s),n=e.level,a=t.level,o=Pn(n,a),l=i?n:o;return Z.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${e.profile}, level:${l}]`),Ps(new Ke(e.profile,l))}function kn(r,s){for(let t=Ts.length-1;t>=0;--t){let i=Ts[t];if(i.max_macroblock_frame_size*256<=r&&i.max_macroblocks_per_second<=s*i.max_macroblock_frame_size)return Z.debug(`supportedLevel() | result [max_frame_pixel_count:${r}, max_fps:${s}, level:${i.level}]`),i.level}Z.warn(`supportedLevel() | no level supported [max_frame_pixel_count:${r}, max_fps:${s}]`)}function xs(r,s){return+(s[0]===r)<<7|+(s[1]===r)<<6|+(s[2]===r)<<5|+(s[3]===r)<<4|+(s[4]===r)<<3|+(s[5]===r)<<2|+(s[6]===r)<<1|+(s[7]===r)<<0}function Dn(r,s){return r===w.L1_b?s!==w.L1&&s!==w.L1_b:s===w.L1_b?r!==w.L1:r<s}function Pn(r,s){return Dn(r,s)?r:s}function ks(r={}){let s=r["level-asymmetry-allowed"];return s===!0||s===1||s==="1"}});var se=x(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.validateAndNormalizeRtpCapabilities=Nn;Q.validateAndNormalizeRtpParameters=vr;Q.validateAndNormalizeSctpStreamParameters=jn;Q.validateSctpCapabilities=Fn;Q.getExtendedRtpCapabilities=An;Q.getRecvRtpCapabilities=qn;Q.getSendingRtpParameters=zn;Q.getSendingRemoteRtpParameters=$n;Q.reduceCodecs=Bn;Q.generateProbatorRtpParameters=Un;Q.canSend=Vn;Q.canReceive=Hn;var Is=Ls(),Ln=Ce(),In="probator",Mn=1234,On=127;function Nn(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(let s of r.codecs)Gn(s);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let s of r.headerExtensions)Qn(s)}function vr(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(let s of r.codecs)Kn(s);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let s of r.headerExtensions)Wn(s);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(let s of r.encodings)Jn(s);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),Yn(r.rtcp)}function jn(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let s=!1;if(typeof r.ordered=="boolean"?s=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(s&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!s&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}function Fn(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");Zn(r.numStreams)}function An(r,s,e){let t={codecs:[],headerExtensions:[]};if(e)for(let i of r.codecs??[]){if(We(i))continue;let n=(s.codecs??[]).find(o=>_r(o,i,{strict:!0,modify:!0}));if(!n)continue;let a={kind:i.kind,mimeType:i.mimeType,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:n.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters??{},remoteParameters:n.parameters??{},rtcpFeedback:Ms(i,n)};t.codecs.push(a)}else for(let i of s.codecs??[]){if(We(i))continue;let n=(r.codecs??[]).find(o=>_r(o,i,{strict:!0,modify:!0}));if(!n)continue;let a={kind:n.kind,mimeType:n.mimeType,clockRate:n.clockRate,channels:n.channels,localPayloadType:n.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:i.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:n.parameters??{},remoteParameters:i.parameters??{},rtcpFeedback:Ms(n,i)};t.codecs.push(a)}for(let i of t.codecs){let n=r.codecs.find(o=>We(o)&&o.parameters?.apt===i.localPayloadType),a=s.codecs.find(o=>We(o)&&o.parameters?.apt===i.remotePayloadType);n&&a&&(i.localRtxPayloadType=n.preferredPayloadType,i.remoteRtxPayloadType=a.preferredPayloadType)}for(let i of s.headerExtensions){let n=r.headerExtensions.find(o=>Xn(o,i));if(!n)continue;let a={kind:i.kind,uri:i.uri,sendId:n.preferredId,recvId:i.preferredId,encrypt:n.preferredEncrypt??!1,direction:"sendrecv"};switch(i.direction){case"sendrecv":{a.direction="sendrecv";break}case"recvonly":{a.direction="sendonly";break}case"sendonly":{a.direction="recvonly";break}case"inactive":{a.direction="inactive";break}}t.headerExtensions.push(a)}return t}function qn(r){let s={codecs:[],headerExtensions:[]};for(let e of r.codecs){let t={kind:e.kind,mimeType:e.mimeType,preferredPayloadType:e.remotePayloadType,clockRate:e.clockRate,channels:e.channels,parameters:e.localParameters,rtcpFeedback:e.rtcpFeedback};if(s.codecs.push(t),!e.remoteRtxPayloadType)continue;let i={kind:e.kind,mimeType:`${e.kind}/rtx`,preferredPayloadType:e.remoteRtxPayloadType,clockRate:e.clockRate,parameters:{apt:e.remotePayloadType},rtcpFeedback:[]};s.codecs.push(i)}for(let e of r.headerExtensions){if(e.direction!=="sendrecv"&&e.direction!=="recvonly")continue;let t={kind:e.kind,uri:e.uri,preferredId:e.recvId,preferredEncrypt:e.encrypt??!1,direction:e.direction};s.headerExtensions.push(t)}return s}function zn(r,s){let e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let t of s.codecs){if(t.kind!==r)continue;let i={mimeType:t.mimeType,payloadType:t.localPayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),t.localRtxPayloadType){let n={mimeType:`${t.kind}/rtx`,payloadType:t.localRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.localPayloadType},rtcpFeedback:[]};e.codecs.push(n)}}for(let t of s.headerExtensions){if(t.kind&&t.kind!==r||t.direction!=="sendrecv"&&t.direction!=="sendonly")continue;let i={uri:t.uri,id:t.sendId,encrypt:t.encrypt,parameters:{}};e.headerExtensions.push(i)}return e}function $n(r,s){let e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let t of s.codecs){if(t.kind!==r)continue;let i={mimeType:t.mimeType,payloadType:t.localPayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.remoteParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),t.localRtxPayloadType){let n={mimeType:`${t.kind}/rtx`,payloadType:t.localRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.localPayloadType},rtcpFeedback:[]};e.codecs.push(n)}}for(let t of s.headerExtensions){if(t.kind&&t.kind!==r||t.direction!=="sendrecv"&&t.direction!=="sendonly")continue;let i={uri:t.uri,id:t.sendId,encrypt:t.encrypt,parameters:{}};e.headerExtensions.push(i)}if(e.headerExtensions.some(t=>t.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(let t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="goog-remb");else if(e.headerExtensions.some(t=>t.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(let t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="transport-cc");else for(let t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return e}function Bn(r,s){let e=[];if(!s)e.push(r[0]),We(r[1])&&e.push(r[1]);else{for(let t=0;t<r.length;++t)if(_r(r[t],s,{strict:!0})){e.push(r[t]),We(r[t+1])&&e.push(r[t+1]);break}if(e.length===0)throw new TypeError("no matching codec found")}return e}function Un(r){r=Ln.clone(r),vr(r);let s={mid:In,codecs:[],headerExtensions:[],encodings:[{ssrc:Mn}],rtcp:{cname:"probator"}};return s.codecs.push(r.codecs[0]),s.codecs[0].payloadType=On,s.headerExtensions=r.headerExtensions,s}function Vn(r,s){return(s.codecs??[]).some(e=>e.kind===r)}function Hn(r,s){if(vr(r),r.codecs.length===0)return!1;let e=r.codecs[0];return(s.codecs??[]).some(t=>t.preferredPayloadType===e.payloadType)}function Gn(r){let s=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let e=s.exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");if(r.kind=e[1].toLowerCase(),typeof r.preferredPayloadType!="number")throw new TypeError("missing codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let t of Object.keys(r.parameters)){let i=r.parameters[t];if(i===void 0&&(r.parameters[t]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if(t==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let t of r.rtcpFeedback)Os(t)}function Os(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}function Qn(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}function Kn(r){let s=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let e=s.exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");e[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let i of Object.keys(r.parameters)){let n=r.parameters[i];if(n===void 0&&(r.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let i of r.rtcpFeedback)Os(i)}function Wn(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let s of Object.keys(r.parameters)){let e=r.parameters[s];if(e===void 0&&(r.parameters[s]="",e=""),typeof e!="string"&&typeof e!="number")throw new TypeError("invalid header extension parameter")}}function Jn(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function Yn(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}function Zn(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}function We(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function _r(r,s,{strict:e=!1,modify:t=!1}={}){let i=r.mimeType.toLowerCase(),n=s.mimeType.toLowerCase();if(i!==n||r.clockRate!==s.clockRate||r.channels!==s.channels)return!1;switch(i){case"video/h264":{if(e){let a=r.parameters["packetization-mode"]??0,o=s.parameters["packetization-mode"]??0;if(a!==o||!Is.isSameProfile(r.parameters,s.parameters))return!1;let l;try{l=Is.generateProfileLevelIdStringForAnswer(r.parameters,s.parameters)}catch{return!1}t&&(l?(r.parameters["profile-level-id"]=l,s.parameters["profile-level-id"]=l):(delete r.parameters["profile-level-id"],delete s.parameters["profile-level-id"]))}break}case"video/vp9":{if(e){let a=r.parameters["profile-id"]??0,o=s.parameters["profile-id"]??0;if(a!==o)return!1}break}}return!0}function Xn(r,s){return!(r.kind&&s.kind&&r.kind!==s.kind||r.uri!==s.uri)}function Ms(r,s){let e=[];for(let t of r.rtcpFeedback??[]){let i=(s.rtcpFeedback??[]).find(n=>n.type===t.type&&(n.parameter===t.parameter||!n.parameter&&!t.parameter));i&&e.push(i)}return e}});var Ns=x(jt=>{"use strict";Object.defineProperty(jt,"__esModule",{value:!0});jt.Logger=void 0;var Je=ut(),Ye="awaitqueue",wr=class{constructor(s){c(this,"_debug");c(this,"_warn");c(this,"_error");s?(this._debug=Je(`${Ye}:${s}`),this._warn=Je(`${Ye}:WARN:${s}`),this._error=Je(`${Ye}:ERROR:${s}`)):(this._debug=Je(Ye),this._warn=Je(`${Ye}:WARN`),this._error=Je(`${Ye}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};jt.Logger=wr});var Sr=x(Ze=>{"use strict";Object.defineProperty(Ze,"__esModule",{value:!0});Ze.AwaitQueueRemovedTaskError=Ze.AwaitQueueStoppedError=void 0;var br=class r extends Error{constructor(s){super(s??"queue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,r)}};Ze.AwaitQueueStoppedError=br;var yr=class r extends Error{constructor(s){super(s??"queue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,r)}};Ze.AwaitQueueRemovedTaskError=yr});var js=x(Ft=>{"use strict";Object.defineProperty(Ft,"__esModule",{value:!0});Ft.AwaitQueue=void 0;var ea=Ns(),Cr=Sr(),de=new ea.Logger("AwaitQueue"),Rr=class{constructor(){c(this,"pendingTasks",new Map);c(this,"nextTaskId",0);de.debug("constructor()")}get size(){return this.pendingTasks.size}async push(s,e,t){if(e=e??s.name,de.debug(`push() [name:${e}, options:%o]`,t),typeof s!="function")throw new TypeError("given task is not a function");if(e)try{Object.defineProperty(s,"name",{value:e})}catch{}return new Promise((i,n)=>{if(e&&t?.removeOngoingTasksWithSameName)for(let o of this.pendingTasks.values())o.name===e&&o.reject(new Cr.AwaitQueueRemovedTaskError,{canExecuteNextTask:!1});let a={id:this.nextTaskId++,task:s,name:e,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:o=>{if(a.completed)return;a.completed=!0,this.pendingTasks.delete(a.id),de.debug(`resolving task [name:${a.name}]`),i(o);let[l]=this.pendingTasks.values();l&&!l.executedAt&&this.execute(l)},reject:(o,{canExecuteNextTask:l})=>{if(!a.completed&&(a.completed=!0,this.pendingTasks.delete(a.id),de.debug(`rejecting task [name:${a.name}]: %s`,String(o)),n(o),l)){let[u]=this.pendingTasks.values();u&&!u.executedAt&&this.execute(u)}}};this.pendingTasks.set(a.id,a),this.pendingTasks.size===1&&this.execute(a)})}stop(){de.debug("stop()");for(let s of this.pendingTasks.values())de.debug(`stop() | stopping task [name:${s.name}]`),s.reject(new Cr.AwaitQueueStoppedError,{canExecuteNextTask:!1})}remove(s){de.debug(`remove() [taskIdx:${s}]`);let e=Array.from(this.pendingTasks.values())[s];if(!e){de.debug(`stop() | no task with given idx [taskIdx:${s}]`);return}e.reject(new Cr.AwaitQueueRemovedTaskError,{canExecuteNextTask:!0})}dump(){let s=Date.now(),e=0;return Array.from(this.pendingTasks.values()).map(t=>({idx:e++,task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt-t.enqueuedAt:s-t.enqueuedAt,executionTime:t.executedAt?s-t.executedAt:0}))}async execute(s){if(de.debug(`execute() [name:${s.name}]`),s.executedAt)throw new Error("task already being executed");s.executedAt=Date.now();try{let e=await s.task();s.resolve(e)}catch(e){s.reject(e,{canExecuteNextTask:!0})}}};Ft.AwaitQueue=Rr});var As=x(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});ge.AwaitQueueRemovedTaskError=ge.AwaitQueueStoppedError=ge.AwaitQueue=void 0;var ta=js();Object.defineProperty(ge,"AwaitQueue",{enumerable:!0,get:function(){return ta.AwaitQueue}});var Fs=Sr();Object.defineProperty(ge,"AwaitQueueStoppedError",{enumerable:!0,get:function(){return Fs.AwaitQueueStoppedError}});Object.defineProperty(ge,"AwaitQueueRemovedTaskError",{enumerable:!0,get:function(){return Fs.AwaitQueueRemovedTaskError}})});var zs=x(At=>{"use strict";Object.defineProperty(At,"__esModule",{value:!0});At.Producer=void 0;var ra=U(),qs=G(),Xe=W(),ie=new ra.Logger("Producer"),Er=class extends qs.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:i,track:n,rtpParameters:a,stopTracks:o,disableTrackOnPause:l,zeroRtpOnPause:u,appData:d}){super();c(this,"_id");c(this,"_localId");c(this,"_closed",!1);c(this,"_rtpSender");c(this,"_track");c(this,"_kind");c(this,"_rtpParameters");c(this,"_paused");c(this,"_maxSpatialLayer");c(this,"_stopTracks");c(this,"_disableTrackOnPause");c(this,"_zeroRtpOnPause");c(this,"_appData");c(this,"_observer",new qs.EnhancedEventEmitter);ie.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=i,this._track=n,this._kind=n.kind,this._rtpParameters=a,this._paused=l?!n.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=o,this._disableTrackOnPause=l,this._zeroRtpOnPause=u,this._appData=d??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(ie.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(ie.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Xe.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(ie.debug("pause()"),this._closed){ie.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(ie.debug("resume()"),this._closed){ie.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(ie.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new Xe.InvalidStateError("closed")}else if(e?.readyState==="ended")throw new Xe.InvalidStateError("track ended");if(e===this._track){ie.debug("replaceTrack() | same track, ignored");return}await new Promise((t,i)=>{this.safeEmit("@replacetrack",e,t,i)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new Xe.InvalidStateError("closed");if(this._kind!=="video")throw new Xe.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,i)=>{this.safeEmit("@setmaxspatiallayer",e,t,i)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new Xe.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,i)=>{this.safeEmit("@setrtpencodingparameters",e,t,i)})}onTrackEnded(){ie.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}};At.Producer=Er});var Bs=x(qt=>{"use strict";Object.defineProperty(qt,"__esModule",{value:!0});qt.Consumer=void 0;var sa=U(),$s=G(),ia=W(),ne=new sa.Logger("Consumer"),Tr=class extends $s.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:n,track:a,rtpParameters:o,appData:l}){super();c(this,"_id");c(this,"_localId");c(this,"_producerId");c(this,"_closed",!1);c(this,"_rtpReceiver");c(this,"_track");c(this,"_rtpParameters");c(this,"_paused");c(this,"_appData");c(this,"_observer",new $s.EnhancedEventEmitter);ne.debug("constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=n,this._track=a,this._rtpParameters=o,this._paused=!a.enabled,this._appData=l??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(ne.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(ne.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new ia.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(ne.debug("pause()"),this._closed){ne.error("pause() | Consumer closed");return}if(this._paused){ne.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(ne.debug("resume()"),this._closed){ne.error("resume() | Consumer closed");return}if(!this._paused){ne.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){ne.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}};qt.Consumer=Tr});var Vs=x(zt=>{"use strict";Object.defineProperty(zt,"__esModule",{value:!0});zt.DataProducer=void 0;var na=U(),Us=G(),aa=W(),pe=new na.Logger("DataProducer"),xr=class extends Us.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:i,appData:n}){super();c(this,"_id");c(this,"_dataChannel");c(this,"_closed",!1);c(this,"_sctpStreamParameters");c(this,"_appData");c(this,"_observer",new Us.EnhancedEventEmitter);pe.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=i,this._appData=n??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(pe.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(pe.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(pe.debug("send()"),this._closed)throw new aa.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(pe.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let t=e.error??new Error("unknown DataChannel error");e.error?.errorDetail==="sctp-failure"?pe.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",e.error?.sctpCauseCode,e.error.message):pe.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(pe.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||pe.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};zt.DataProducer=xr});var Gs=x($t=>{"use strict";Object.defineProperty($t,"__esModule",{value:!0});$t.DataConsumer=void 0;var oa=U(),Hs=G(),Ee=new oa.Logger("DataConsumer"),kr=class extends Hs.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:i,sctpStreamParameters:n,appData:a}){super();c(this,"_id");c(this,"_dataProducerId");c(this,"_dataChannel");c(this,"_closed",!1);c(this,"_sctpStreamParameters");c(this,"_appData");c(this,"_observer",new Hs.EnhancedEventEmitter);Ee.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=i,this._sctpStreamParameters=n,this._appData=a??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Ee.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(Ee.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Ee.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let t=e.error??new Error("unknown DataChannel error");e.error?.errorDetail==="sctp-failure"?Ee.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",e.error?.sctpCauseCode,e.error.message):Ee.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Ee.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}};$t.DataConsumer=kr});var Ks=x(Bt=>{"use strict";Object.defineProperty(Bt,"__esModule",{value:!0});Bt.Transport=void 0;var ca=As(),da=U(),Qs=G(),q=W(),Dr=Ce(),mt=se(),pa=zs(),la=Bs(),ua=Vs(),ha=Gs(),A=new da.Logger("Transport"),Pr=class{constructor(s){c(this,"consumerOptions");c(this,"promise");c(this,"resolve");c(this,"reject");this.consumerOptions=s,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}},Lr=class extends Qs.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:a,sctpParameters:o,iceServers:l,iceTransportPolicy:u,additionalSettings:d,appData:p,handlerFactory:h,getSendExtendedRtpCapabilities:m,recvRtpCapabilities:g,canProduceByKind:v}){super();c(this,"_id");c(this,"_closed",!1);c(this,"_direction");c(this,"_getSendExtendedRtpCapabilities");c(this,"_recvRtpCapabilities");c(this,"_canProduceByKind");c(this,"_maxSctpMessageSize");c(this,"_handler");c(this,"_iceGatheringState","new");c(this,"_connectionState","new");c(this,"_appData");c(this,"_producers",new Map);c(this,"_consumers",new Map);c(this,"_dataProducers",new Map);c(this,"_dataConsumers",new Map);c(this,"_probatorConsumerCreated",!1);c(this,"_awaitQueue",new ca.AwaitQueue);c(this,"_pendingConsumerTasks",[]);c(this,"_consumerCreationInProgress",!1);c(this,"_pendingPauseConsumers",new Map);c(this,"_consumerPauseInProgress",!1);c(this,"_pendingResumeConsumers",new Map);c(this,"_consumerResumeInProgress",!1);c(this,"_pendingCloseConsumers",new Map);c(this,"_consumerCloseInProgress",!1);c(this,"_observer",new Qs.EnhancedEventEmitter);A.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._getSendExtendedRtpCapabilities=m,this._recvRtpCapabilities=g,this._canProduceByKind=v,this._maxSctpMessageSize=o?o.maxMessageSize:null;let f=Dr.clone(d)??{};delete f.iceServers,delete f.iceTransportPolicy,delete f.bundlePolicy,delete f.rtcpMuxPolicy,this._handler=h.factory({direction:e,iceParameters:i,iceCandidates:n,dtlsParameters:a,sctpParameters:o,iceServers:l,iceTransportPolicy:u,additionalSettings:f,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities}),this._appData=p??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){if(!this._closed){A.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(let e of this._producers.values())e.transportClosed();this._producers.clear();for(let e of this._consumers.values())e.transportClosed();this._consumers.clear();for(let e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(let e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close"),super.close(),this._observer.close()}}async getStats(){if(this._closed)throw new q.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(A.debug("restartIce()"),this._closed)throw new q.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(A.debug("updateIceServers()"),this._closed)throw new q.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,streamId:t,encodings:i,codecOptions:n,headerExtensionOptions:a,codec:o,stopTracks:l=!0,disableTrackOnPause:u=!0,zeroRtpOnPause:d=!1,onRtpSender:p,appData:h={}}={}){if(A.debug("produce() [track:%o]",e),this._closed)throw new q.InvalidStateError("closed");if(e){if(this._direction!=="send")throw new q.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new q.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(h&&typeof h!="object")throw new TypeError("if given, appData must be an object")}else throw new q.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let m;if(i&&!Array.isArray(i))throw TypeError("encodings must be an array");i?.length===0?m=void 0:i&&(m=i.map(_=>{let T={active:!0};return _.active===!1&&(T.active=!1),typeof _.dtx=="boolean"&&(T.dtx=_.dtx),typeof _.scalabilityMode=="string"&&(T.scalabilityMode=_.scalabilityMode),typeof _.scaleResolutionDownBy=="number"&&(T.scaleResolutionDownBy=_.scaleResolutionDownBy),typeof _.maxBitrate=="number"&&(T.maxBitrate=_.maxBitrate),typeof _.maxFramerate=="number"&&(T.maxFramerate=_.maxFramerate),typeof _.adaptivePtime=="boolean"&&(T.adaptivePtime=_.adaptivePtime),typeof _.priority=="string"&&(T.priority=_.priority),typeof _.networkPriority=="string"&&(T.networkPriority=_.networkPriority),T}));let{localId:g,rtpParameters:v,rtpSender:f}=await this._handler.send({track:e,streamId:t,encodings:m,codecOptions:n,headerExtensionOptions:a,codec:o,onRtpSender:p});try{mt.validateAndNormalizeRtpParameters(v);let{id:_}=await new Promise((P,L)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:v,appData:h},P,L)}),T=new pa.Producer({id:_,localId:g,rtpSender:f,track:e,rtpParameters:v,stopTracks:l,disableTrackOnPause:u,zeroRtpOnPause:d,appData:h});return this._producers.set(T.id,T),this.handleProducer(T),this._observer.safeEmit("newproducer",T),T}catch(_){throw this._handler.stopSending(g).catch(()=>{}),_}},"transport.produce()").catch(m=>{if(l)try{e.stop()}catch{}throw m})}async consume({id:e,producerId:t,kind:i,rtpParameters:n,streamId:a,onRtpReceiver:o,appData:l={}}){if(A.debug("consume()"),this._closed)throw new q.InvalidStateError("closed");if(this._direction!=="recv")throw new q.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(i!=="audio"&&i!=="video")throw new TypeError(`invalid kind '${i}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(l&&typeof l!="object")throw new TypeError("if given, appData must be an object");let u=Dr.clone(n);if(!mt.canReceive(u,this._recvRtpCapabilities))throw new q.UnsupportedError("cannot consume this Producer");let p=new Pr({id:e,producerId:t,kind:i,rtpParameters:u,streamId:a,onRtpReceiver:o,appData:l});return this._pendingConsumerTasks.push(p),queueMicrotask(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),p.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:i,label:n="",protocol:a="",appData:o={}}={}){if(A.debug("produceData()"),this._closed)throw new q.InvalidStateError("closed");if(this._direction!=="send")throw new q.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new q.UnsupportedError("SCTP not enabled by remote Transport");return(t||i)&&(e=!1),this._awaitQueue.push(async()=>{let{dataChannel:l,sctpStreamParameters:u}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a});mt.validateAndNormalizeSctpStreamParameters(u);let{id:d}=await new Promise((h,m)=>{this.safeEmit("producedata",{sctpStreamParameters:u,label:n,protocol:a,appData:o},h,m)}),p=new ua.DataProducer({id:d,dataChannel:l,sctpStreamParameters:u,appData:o});return this._dataProducers.set(p.id,p),this.handleDataProducer(p),this._observer.safeEmit("newdataproducer",p),p},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:i,label:n="",protocol:a="",appData:o={}}){if(A.debug("consumeData()"),this._closed)throw new q.InvalidStateError("closed");if(this._direction!=="recv")throw new q.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new q.UnsupportedError("SCTP not enabled by remote Transport");let l=Dr.clone(i);return mt.validateAndNormalizeSctpStreamParameters(l),this._awaitQueue.push(async()=>{let{dataChannel:u}=await this._handler.receiveDataChannel({sctpStreamParameters:l,label:n,protocol:a}),d=new ha.DataConsumer({id:e,dataProducerId:t,dataChannel:u,sctpStreamParameters:l,appData:o});return this._dataConsumers.set(d.id,d),this.handleDataConsumer(d),this._observer.safeEmit("newdataconsumer",d),d},"transport.consumeData()")}createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){A.debug("createPendingConsumers() | there is no Consumer to be created");return}let e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t,i=[];for(let n of e){let{id:a,kind:o,rtpParameters:l,streamId:u,onRtpReceiver:d}=n.consumerOptions;i.push({trackId:a,kind:o,rtpParameters:l,streamId:u,onRtpReceiver:d})}try{let n=await this._handler.receive(i);for(let a=0;a<n.length;++a){let o=e[a],l=n[a],{id:u,producerId:d,kind:p,rtpParameters:h,appData:m}=o.consumerOptions,{localId:g,rtpReceiver:v,track:f}=l,_=new la.Consumer({id:u,localId:g,producerId:d,rtpReceiver:v,track:f,rtpParameters:h,appData:m});this._consumers.set(_.id,_),this.handleConsumer(_),!this._probatorConsumerCreated&&!t&&p==="video"&&(t=_),this._observer.safeEmit("newconsumer",_),o.resolve(_)}}catch(n){for(let a of e)a.reject(n)}if(t)try{let n=mt.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:n}]),A.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(n){A.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",n)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){A.debug("pausePendingConsumers() | there is no Consumer to be paused");return}let e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{let t=e.map(i=>i.localId);await this._handler.pauseReceiving(t)}catch(t){A.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers()").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){A.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}let e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{let t=e.map(i=>i.localId);await this._handler.resumeReceiving(t)}catch(t){A.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers()").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){A.debug("closePendingConsumers() | there is no Consumer to be closed");return}let e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){A.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers()").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){let e=this._handler;e.on("@connect",({dtlsParameters:t},i,n)=>{if(this._closed){n(new q.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},i,n)}),e.on("@icegatheringstatechange",t=>{t!==this._iceGatheringState&&(A.debug("ICE gathering state changed to %s",t),this._iceGatheringState=t,this._closed||this.safeEmit("icegatheringstatechange",t))}),e.on("@icecandidateerror",t=>{A.warn(`ICE candidate error [url:${t.url}, localAddress:${t.address}, localPort:${t.port}]: ${t.errorCode} "${t.errorText}"`),this.safeEmit("icecandidateerror",t)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(A.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(e.localId),"producer @close event").catch(t=>A.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,i)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(i)}),e.on("@resume",(t,i)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(i)}),e.on("@replacetrack",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(i).catch(n)}),e.on("@setmaxspatiallayer",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(i).catch(n)}),e.on("@setrtpencodingparameters",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(i).catch(n)}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new q.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),queueMicrotask(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),queueMicrotask(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new q.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}};Bt.Transport=Lr});var Ut=x((bc,Js)=>{var Ws=Js.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var s="candidate:%s %d %s %d %s %d typ %s";return s+=r.raddr!=null?" raddr %s rport %d":"%v%v",s+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(s+=" generation %d"),s+=r["network-id"]!=null?" network-id %d":"%v",s+=r["network-cost"]!=null?" network-cost %d":"%v",s}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var s="ssrc:%d";return r.attribute!=null&&(s+=" %s",r.value!=null&&(s+=":%s")),s}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var s="mediaclk:";return s+=r.id!=null?"id=%s %s":"%v%s",s+=r.mediaClockValue!=null?"=%s":"",s+=r.rateNumerator!=null?" rate=%s":"",s+=r.rateDenominator!=null?"/%s":"",s}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Ws).forEach(function(r){var s=Ws[r];s.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})});var Xs=x(le=>{var et=function(r){return String(Number(r))===r?Number(r):r},ma=function(r,s,e,t){if(t&&!e)s[t]=et(r[1]);else for(var i=0;i<e.length;i+=1)r[i+1]!=null&&(s[e[i]]=et(r[i+1]))},fa=function(r,s,e){var t=r.name&&r.names;r.push&&!s[r.push]?s[r.push]=[]:t&&!s[r.name]&&(s[r.name]={});var i=r.push?{}:t?s[r.name]:s;ma(e.match(r.reg),i,r.names,r.name),r.push&&s[r.push].push(i)},Ys=Ut(),ga=RegExp.prototype.test.bind(/^([a-z])=(.*)/);le.parse=function(r){var s={},e=[],t=s;return r.split(/(\r\n|\r|\n)/).filter(ga).forEach(function(i){var n=i[0],a=i.slice(2);n==="m"&&(e.push({rtp:[],fmtp:[]}),t=e[e.length-1]);for(var o=0;o<(Ys[n]||[]).length;o+=1){var l=Ys[n][o];if(l.reg.test(a))return fa(l,t,a)}}),s.media=e,s};var Zs=function(r,s){var e=s.split(/=(.+)/,2);return e.length===2?r[e[0]]=et(e[1]):e.length===1&&s.length>1&&(r[e[0]]=void 0),r};le.parseParams=function(r){return r.split(/;\s?/).reduce(Zs,{})};le.parseFmtpConfig=le.parseParams;le.parsePayloads=function(r){return r.toString().split(" ").map(Number)};le.parseRemoteCandidates=function(r){for(var s=[],e=r.split(" ").map(et),t=0;t<e.length;t+=3)s.push({component:e[t],ip:e[t+1],port:e[t+2]});return s};le.parseImageAttributes=function(r){return r.split(" ").map(function(s){return s.substring(1,s.length-1).split(",").reduce(Zs,{})})};le.parseSimulcastStreamList=function(r){return r.split(";").map(function(s){return s.split(",").map(function(e){var t,i=!1;return e[0]!=="~"?t=et(e):(t=et(e.substring(1,e.length)),i=!0),{scid:t,paused:i}})})}});var ti=x((Sc,ei)=>{var Ir=Ut(),_a=/%[sdv%]/g,va=function(r){var s=1,e=arguments,t=e.length;return r.replace(_a,function(i){if(s>=t)return i;var n=e[s];switch(s+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},ft=function(r,s,e){var t=s.format instanceof Function?s.format(s.push?e:e[s.name]):s.format,i=[r+"="+t];if(s.names)for(var n=0;n<s.names.length;n+=1){var a=s.names[n];s.name?i.push(e[s.name][a]):i.push(e[s.names[n]])}else i.push(e[s.name]);return va.apply(null,i)},wa=["v","o","s","i","u","e","p","c","b","t","r","z","a"],ba=["i","c","b","a"];ei.exports=function(r,s){s=s||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var e=s.outerOrder||wa,t=s.innerOrder||ba,i=[];return e.forEach(function(n){Ir[n].forEach(function(a){a.name in r&&r[a.name]!=null?i.push(ft(n,a,r)):a.push in r&&r[a.push]!=null&&r[a.push].forEach(function(o){i.push(ft(n,a,o))})})}),r.media.forEach(function(n){i.push(ft("m",Ir.m[0],n)),t.forEach(function(a){Ir[a].forEach(function(o){o.name in n&&n[o.name]!=null?i.push(ft(a,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(l){i.push(ft(a,o,l))})})})}),i.join(`\r
`)+`\r
`}});var ue=x(ae=>{var Te=Xs(),ya=ti(),Sa=Ut();ae.grammar=Sa;ae.write=ya;ae.parse=Te.parse;ae.parseParams=Te.parseParams;ae.parseFmtpConfig=Te.parseFmtpConfig;ae.parsePayloads=Te.parsePayloads;ae.parseRemoteCandidates=Te.parseRemoteCandidates;ae.parseImageAttributes=Te.parseImageAttributes;ae.parseSimulcastStreamList=Te.parseSimulcastStreamList});var xe=x(Mr=>{"use strict";Object.defineProperty(Mr,"__esModule",{value:!0});Mr.parse=Ra;var Ca=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Ra(r){let s=Ca.exec(r??"");return s?{spatialLayers:Number(s[1]),temporalLayers:Number(s[2])}:{spatialLayers:1,temporalLayers:1}}});var ii=x(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});_e.OfferMediaSection=_e.AnswerMediaSection=_e.MediaSection=void 0;var Ea=ue(),ri=Ce(),gt=class{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t}){c(this,"_mediaObject");if(this._mediaObject={type:"",port:0,protocol:"",payloads:"",rtp:[],fmtp:[]},s&&this.setIceParameters(s),e){this._mediaObject.candidates=[];for(let i of e){let n={foundation:i.foundation,component:1,ip:i.address??i.ip,port:i.port,priority:i.priority,transport:i.protocol,type:i.type};i.tcpType&&(n.tcptype=i.tcpType),this._mediaObject.candidates.push(n)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}t&&this.setDtlsRole(t.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(s){this._mediaObject.iceUfrag=s.usernameFragment,this._mediaObject.icePwd=s.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause()}close(){this.disable(),this._mediaObject.port=0,delete this._mediaObject.candidates,delete this._mediaObject.endOfCandidates,delete this._mediaObject.iceUfrag,delete this._mediaObject.icePwd,delete this._mediaObject.iceOptions,this._mediaObject.rtp=[],this._mediaObject.fmtp=[],delete this._mediaObject.rtcp,delete this._mediaObject.rtcpFb,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}};_e.MediaSection=gt;var Or=class extends gt{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,offerMediaObject:a,offerRtpParameters:o,answerRtpParameters:l,codecOptions:u}){switch(super({iceParameters:s,iceCandidates:e,dtlsParameters:t}),this._mediaObject.mid=String(a.mid),this._mediaObject.type=a.type,this._mediaObject.protocol=a.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),a.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(let d of l.codecs){let p={payload:d.payloadType,codec:si(d),rate:d.clockRate};d.channels>1&&(p.encoding=d.channels),this._mediaObject.rtp.push(p);let h=ri.clone(d.parameters)??{},m=ri.clone(d.rtcpFeedback)??[];if(u){let{opusStereo:v,opusFec:f,opusDtx:_,opusMaxPlaybackRate:T,opusMaxAverageBitrate:P,opusPtime:L,opusNack:O,videoGoogleStartBitrate:k,videoGoogleMaxBitrate:j,videoGoogleMinBitrate:be}=u,fe=o.codecs.find(ye=>ye.payloadType===d.payloadType);switch(d.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{v!==void 0&&(fe.parameters["sprop-stereo"]=v?1:0,h.stereo=v?1:0),f!==void 0&&(fe.parameters.useinbandfec=f?1:0,h.useinbandfec=f?1:0),_!==void 0&&(fe.parameters.usedtx=_?1:0,h.usedtx=_?1:0),T!==void 0&&(h.maxplaybackrate=T),P!==void 0&&(h.maxaveragebitrate=P),L!==void 0&&(fe.parameters.ptime=L,h.ptime=L),O||(fe.rtcpFeedback=fe.rtcpFeedback.filter(ye=>ye.type!=="nack"||ye.parameter),m=m.filter(ye=>ye.type!=="nack"||ye.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":case"video/av1":{k!==void 0&&(h["x-google-start-bitrate"]=k),j!==void 0&&(h["x-google-max-bitrate"]=j),be!==void 0&&(h["x-google-min-bitrate"]=be);break}}}let g={payload:d.payloadType,config:""};for(let v of Object.keys(h))g.config&&(g.config+=";"),g.config+=`${v}=${h[v]}`;g.config&&this._mediaObject.fmtp.push(g);for(let v of m)this._mediaObject.rtcpFb.push({payload:d.payloadType,type:v.type,subtype:v.parameter})}this._mediaObject.payloads=l.codecs.map(d=>d.payloadType).join(" "),this._mediaObject.ext=[];for(let d of l.headerExtensions)(a.ext??[]).some(h=>h.uri===d.uri)&&this._mediaObject.ext.push({uri:d.uri,value:d.id});if(a.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),a.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:a.simulcast.list1},this._mediaObject.rids=[];for(let d of a.rids??[])d.direction==="send"&&this._mediaObject.rids.push({id:d.id,direction:"recv"})}else if(a.simulcast_03){this._mediaObject.simulcast_03={value:a.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(let d of a.rids??[])d.direction==="send"&&this._mediaObject.rids.push({id:d.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";break}case"application":{typeof a.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):a.sctpmap&&(this._mediaObject.payloads=String(i.port),this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(s){switch(s){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(s){if(!this._mediaObject.simulcast?.list1)return;let e={};for(let n of s)n.rid&&(e[n.rid]=n);let t=this._mediaObject.simulcast.list1,i=Ea.parseSimulcastStreamList(t);for(let n of i)for(let a of n)a.paused=!e[a.scid]?.active;this._mediaObject.simulcast.list1=i.map(n=>n.map(a=>`${a.paused?"~":""}${a.scid}`).join(",")).join(";")}};_e.AnswerMediaSection=Or;var Nr=class extends gt{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,mid:a,kind:o,offerRtpParameters:l,streamId:u,trackId:d}){switch(super({iceParameters:s,iceCandidates:e,dtlsParameters:t}),this._mediaObject.mid=String(a),this._mediaObject.type=o,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),this._mediaObject.extmapAllowMixed="extmap-allow-mixed",o){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._mediaObject.msid=[{id:u,appdata:d}];for(let g of l.codecs){let v={payload:g.payloadType,codec:si(g),rate:g.clockRate};g.channels>1&&(v.encoding=g.channels),this._mediaObject.rtp.push(v);let f={payload:g.payloadType,config:""};for(let _ of Object.keys(g.parameters??{}))f.config&&(f.config+=";"),f.config+=`${_}=${g.parameters[_]}`;f.config&&this._mediaObject.fmtp.push(f);for(let _ of g.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:g.payloadType,type:_.type,subtype:_.parameter})}this._mediaObject.payloads=l.codecs.map(g=>g.payloadType).join(" "),this._mediaObject.ext=[];for(let g of l.headerExtensions)this._mediaObject.ext.push({uri:g.uri,value:g.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";let p=l.encodings[0],h=p.ssrc,m=p.rtx?.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],h&&l.rtcp.cname&&this._mediaObject.ssrcs.push({id:h,attribute:"cname",value:l.rtcp.cname}),m&&(l.rtcp.cname&&this._mediaObject.ssrcs.push({id:m,attribute:"cname",value:l.rtcp.cname}),h&&this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${m}`}));break}case"application":{this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize;break}}}setDtlsRole(s){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}};_e.OfferMediaSection=Nr;function si(r){let e=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");return e[2]}});var tt=x(Gt=>{"use strict";Object.defineProperty(Gt,"__esModule",{value:!0});Gt.RemoteSdp=void 0;var Ta=ue(),xa=U(),Vt=ii(),ka=["av1","h264"],Ht=new xa.Logger("RemoteSdp"),jr=class{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n}){c(this,"_iceParameters");c(this,"_iceCandidates");c(this,"_dtlsParameters");c(this,"_sctpParameters");c(this,"_plainRtpParameters");c(this,"_mediaSections",[]);c(this,"_midToIndex",new Map);c(this,"_firstMid");c(this,"_sdpObject");if(this._iceParameters=s,this._iceCandidates=e,this._dtlsParameters=t,this._sctpParameters=i,this._plainRtpParameters=n,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:"10000",sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},this._sdpObject.iceOptions="ice2",s?.iceLite&&(this._sdpObject.icelite="ice-lite"),t){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};let a=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:t.fingerprints[a-1].algorithm,hash:t.fingerprints[a-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(s){Ht.debug("updateIceParameters() [iceParameters:%o]",s),this._iceParameters=s,this._sdpObject.icelite=s.iceLite?"ice-lite":void 0;for(let e of this._mediaSections)e.setIceParameters(s)}updateDtlsRole(s){Ht.debug("updateDtlsRole() [role:%s]",s),this._dtlsParameters.role=s;for(let e of this._mediaSections)e.setDtlsRole(s)}setSessionExtmapAllowMixed(){Ht.debug("setSessionExtmapAllowMixed()"),this._sdpObject.extmapAllowMixed="extmap-allow-mixed"}getNextMediaSectionIdx(){for(let s=0;s<this._mediaSections.length;++s){let e=this._mediaSections[s];if(e.closed)return{idx:s,reuseMid:e.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:s,reuseMid:e,offerRtpParameters:t,answerRtpParameters:i,codecOptions:n}){let a=new Vt.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:s,offerRtpParameters:t,answerRtpParameters:i,codecOptions:n}),o=a.getObject();o.rtp.find(u=>ka.includes(u.codec.toLowerCase()))||(o.ext=o.ext?.filter(u=>u.uri!=="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension")),e?this.replaceMediaSection(a,e):this._midToIndex.has(a.mid)?this.replaceMediaSection(a):this.addMediaSection(a)}receive({mid:s,kind:e,offerRtpParameters:t,streamId:i,trackId:n}){this.setSessionExtmapAllowMixed();let a=new Vt.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,mid:s,kind:e,offerRtpParameters:t,streamId:i,trackId:n}),o=this._mediaSections.find(l=>l.closed);o?this.replaceMediaSection(a,o.mid):this.addMediaSection(a)}pauseMediaSection(s){this.findMediaSection(s).pause()}resumeSendingMediaSection(s){this.findMediaSection(s).resume()}resumeReceivingMediaSection(s){this.findMediaSection(s).resume()}disableMediaSection(s){this.findMediaSection(s).disable()}closeMediaSection(s){let e=this.findMediaSection(s);return s===this._firstMid?(Ht.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",s),this.disableMediaSection(s),!1):(e.close(),this.regenerateBundleMids(),!0)}muxMediaSectionSimulcast(s,e){let t=this.findMediaSection(s);t.muxSimulcastStreams(e),this.replaceMediaSection(t)}sendSctpAssociation({offerMediaObject:s}){let e=new Vt.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:s});this.addMediaSection(e)}receiveSctpAssociation(){let s=new Vt.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application"});this.addMediaSection(s)}getSdp(){return this._sdpObject.origin.sessionVersion++,Ta.write(this._sdpObject)}addMediaSection(s){this._firstMid||(this._firstMid=s.mid),this._mediaSections.push(s),this._midToIndex.set(s.mid,this._mediaSections.length-1),this._sdpObject.media.push(s.getObject()),this.regenerateBundleMids()}replaceMediaSection(s,e){if(typeof e=="string"){let t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found for reuseMid '${e}'`);let i=this._mediaSections[t];this._mediaSections[t]=s,this._midToIndex.delete(i.mid),this._midToIndex.set(s.mid,t),this._sdpObject.media[t]=s.getObject(),this.regenerateBundleMids()}else{let t=this._midToIndex.get(s.mid);if(t===void 0)throw new Error(`no media section found with mid '${s.mid}'`);this._mediaSections[t]=s,this._sdpObject.media[t]=s.getObject()}}findMediaSection(s){let e=this._midToIndex.get(s);if(e===void 0)throw new Error(`no media section found with mid '${s}'`);return this._mediaSections[e]}regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(s=>!s.closed).map(s=>s.mid).join(" "))}};Gt.RemoteSdp=jr});var rt=x(ke=>{"use strict";Object.defineProperty(ke,"__esModule",{value:!0});ke.extractRtpCapabilities=Da;ke.extractDtlsParameters=Pa;ke.getCname=La;ke.applyCodecParameters=Ia;ke.addHeaderExtension=Ma;var ni=ue();function Da({sdpObject:r}){let s=new Map,e=new Map;for(let i of r.media){let n=i.type;switch(n){case"audio":case"video":break;default:continue}for(let a of i.rtp){let o={kind:n,mimeType:`${n}/${a.codec}`,preferredPayloadType:a.payload,clockRate:a.rate,channels:a.encoding,parameters:{},rtcpFeedback:[]};s.set(o.preferredPayloadType,o)}for(let a of i.fmtp??[]){let o=ni.parseParams(a.config),l=s.get(a.payload);l&&(o?.hasOwnProperty("profile-level-id")&&(o["profile-level-id"]=String(o["profile-level-id"])),l.parameters=o)}for(let a of i.rtcpFb??[]){let o={type:a.type,parameter:a.subtype};if(o.parameter||delete o.parameter,a.payload!=="*"){let l=s.get(Number(a.payload));if(!l)continue;l.rtcpFeedback.push(o)}else for(let l of s.values())l.kind===n&&!/.+\/rtx$/i.test(l.mimeType)&&l.rtcpFeedback.push(o)}for(let a of i.ext??[]){if(a["encrypt-uri"])continue;let o={kind:n,uri:a.uri,preferredId:a.value};e.set(o.preferredId,o)}}return{codecs:Array.from(s.values()),headerExtensions:Array.from(e.values())}}function Pa({sdpObject:r}){let s=r.setup,e=r.fingerprint;if(!s||!e){let n=(r.media??[]).find(a=>a.port!==0);n&&(s=s??n.setup,e=e??n.fingerprint)}if(s){if(!e)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let t;switch(s){case"active":{t="client";break}case"passive":{t="server";break}case"actpass":{t="auto";break}}return{role:t,fingerprints:[{algorithm:e.type,value:e.hash}]}}function La({offerMediaObject:r}){let s=(r.ssrcs??[]).find(e=>e.attribute==="cname");return s?s.value:""}function Ia({offerRtpParameters:r,answerMediaObject:s}){for(let e of r.codecs){let t=e.mimeType.toLowerCase();if(t!=="audio/opus"||!(s.rtp??[]).find(o=>o.payload===e.payloadType))continue;s.fmtp=s.fmtp??[];let n=s.fmtp.find(o=>o.payload===e.payloadType);n||(n={payload:e.payloadType,config:""},s.fmtp.push(n));let a=ni.parseParams(n.config);switch(t){case"audio/opus":{let o=e.parameters?.["sprop-stereo"];o!==void 0&&(a.stereo=Number(o)?1:0);break}}n.config="";for(let o of Object.keys(a))n.config&&(n.config+=";"),n.config+=`${o}=${a[o]}`}}function Ma({offerMediaObject:r,headerExtensionUri:s,headerExtensionId:e}){r.ext||(r.ext=[]),r.ext.push({uri:s,value:e})}});var st=x(Qt=>{"use strict";Object.defineProperty(Qt,"__esModule",{value:!0});Qt.getRtpEncodings=Oa;Qt.addLegacySimulcast=Na;function Oa({offerMediaObject:r}){let s=new Set;for(let i of r.ssrcs??[]){let n=i.id;n&&s.add(n)}if(s.size===0)throw new Error("no a=ssrc lines found");let e=new Map;for(let i of r.ssrcGroups??[]){if(i.semantics!=="FID")continue;let n=i.ssrcs.split(/\s+/),a=Number(n[0]),o=Number(n[1]);s.has(a)&&(s.delete(a),s.delete(o),e.set(a,o))}for(let i of s)e.set(i,void 0);let t=[];for(let[i,n]of e){let a={ssrc:i};n&&(a.rtx={ssrc:n}),t.push(a)}return t}function Na({offerMediaObject:r,numStreams:s}){if(s<=1)throw new TypeError("numStreams must be greater than 1");let e=(r.ssrcs??[]).find(p=>p.attribute==="msid");if(!e)throw new Error("a=ssrc line with msid information not found");let[t,i]=e.value.split(" "),n=Number(e.id),a;(r.ssrcGroups??[]).some(p=>{if(p.semantics!=="FID")return!1;let h=p.ssrcs.split(/\s+/);return Number(h[0])===n?(a=Number(h[1]),!0):!1});let o=(r.ssrcs??[]).find(p=>p.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");let l=o.value,u=[],d=[];for(let p=0;p<s;++p)u.push(n+p),a&&d.push(a+p);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:u.join(" ")});for(let p of u)r.ssrcs.push({id:p,attribute:"cname",value:l}),r.ssrcs.push({id:p,attribute:"msid",value:`${t} ${i}`});for(let p=0;p<d.length;++p){let h=u[p],m=d[p];r.ssrcs.push({id:m,attribute:"cname",value:l}),r.ssrcs.push({id:m,attribute:"msid",value:`${t} ${i}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${m}`})}}});var it=x(_t=>{"use strict";Object.defineProperty(_t,"__esModule",{value:!0});_t.addNackSupportForOpus=ja;_t.addHeaderExtensionSupport=Fa;_t.getMsidStreamIdAndTrackId=Aa;function ja(r){for(let s of r.codecs??[])(s.mimeType.toLowerCase()==="audio/opus"||s.mimeType.toLowerCase()==="audio/multiopus")&&!s.rtcpFeedback?.some(e=>e.type==="nack"&&!e.parameter)&&(s.rtcpFeedback||(s.rtcpFeedback=[]),s.rtcpFeedback.push({type:"nack"}))}function Fa(r,s){let e,t=r.headerExtensions?.find(n=>n.uri===s.uri);if(t){if(t.kind===s.kind)return;e=t.preferredId}if(r.headerExtensions||(r.headerExtensions=[]),e===void 0){e=1;let n=new Set(r.headerExtensions.map(a=>a.preferredId));for(;n.has(e);)++e}let i={kind:s.kind,uri:s.uri,preferredId:e,preferredEncrypt:!1,direction:s.direction};r.headerExtensions.push(i)}function Aa(r){if(!r||typeof r!="string")return{msidStreamId:void 0,msidTrackId:void 0};let[s,e]=r.trim().split(/\s+/);return s?{msidStreamId:s,msidTrackId:e}:{msidStreamId:void 0,msidTrackId:void 0}}});var di=x(Kt=>{"use strict";Object.defineProperty(Kt,"__esModule",{value:!0});Kt.Chrome111=void 0;var he=ue(),qa=G(),za=U(),vt=se(),$a=W(),Ba=xe(),Ua=tt(),wt=rt(),ai=st(),Fr=it(),R=new za.Logger("Chrome111"),oi="Chrome111",ci={OS:1024,MIS:1024},Ar=class r extends qa.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,getSendExtendedRtpCapabilities:d}){super();c(this,"_closed",!1);c(this,"_direction");c(this,"_remoteSdp");c(this,"_getSendExtendedRtpCapabilities");c(this,"_forcedLocalDtlsRole");c(this,"_pc");c(this,"_mapMidTransceiver",new Map);c(this,"_sendStream",new MediaStream);c(this,"_hasDataChannelMediaSection",!1);c(this,"_nextSendSctpStreamId",0);c(this,"_transportReady",!1);c(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});c(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});c(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});c(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});R.debug("constructor()"),this._direction=e,this._remoteSdp=new Ua.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:l??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(R.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:oi,factory:e=>new r(e),getNativeRtpCapabilities:async()=>{R.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video",{sendEncodings:[{scalabilityMode:"L3T3"}]});let t=await e.createOffer();try{e.close()}catch{}e=void 0;let i=he.parse(t.sdp);return r.getLocalRtpCapabilities(i)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(R.debug("getNativeSctpCapabilities()"),{numStreams:ci})}}static getLocalRtpCapabilities(e,t=[]){let i=wt.extractRtpCapabilities({sdpObject:e});vt.validateAndNormalizeRtpCapabilities(i),Fr.addNackSupportForOpus(i);for(let n of t)Fr.addHeaderExtensionSupport(i,n);return i}get name(){return oi}close(){if(R.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),R.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),R.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});R.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();R.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:i,codecOptions:n,headerExtensionOptions:a,codec:o,onRtpSender:l}){if(this.assertNotClosed(),this.assertSendDirection(),R.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),i&&i.length>1){let O=1;for(let k of i){let j=k.scalabilityMode?(0,Ba.parse)(k.scalabilityMode).temporalLayers:3;j>O&&(O=j)}i.forEach((k,j)=>{k.rid=`r${j}`,k.scalabilityMode=`L1T${O}`})}let u=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i});l&&l(d.sender);let p=await this._pc.createOffer(),h=he.parse(p.sdp);h.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let m=[];m.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});let g=r.getLocalRtpCapabilities(h,m),v=this._getSendExtendedRtpCapabilities(g),f=vt.getSendingRtpParameters(e.kind,v);f.codecs=vt.reduceCodecs(f.codecs,o);let _=vt.getSendingRemoteRtpParameters(e.kind,v);if(_.codecs=vt.reduceCodecs(_.codecs,o),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:h}),a?.absCaptureTime){let O=h.media[u.idx];wt.addHeaderExtension({offerMediaObject:O,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:_.headerExtensions.find(k=>k.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),p={type:"offer",sdp:he.write(h)}}R.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);let T=d.mid;f.mid=T,h=he.parse(this._pc.localDescription.sdp);let P=h.media[u.idx];if(f.rtcp.cname=wt.getCname({offerMediaObject:P}),f.msid=`${t??this._sendStream.id} ${e.id}`,!i)f.encodings=ai.getRtpEncodings({offerMediaObject:P});else if(i.length===1){let O=ai.getRtpEncodings({offerMediaObject:P});Object.assign(O[0],i[0]),f.encodings=O}else f.encodings=i;this._remoteSdp.send({offerMediaObject:P,reuseMid:u.reuseMid,offerRtpParameters:f,answerRtpParameters:_,codecOptions:n});let L={type:"answer",sdp:this._remoteSdp.getSdp()};return R.debug("send() | calling pc.setRemoteDescription() [answer:%o]",L),await this._pc.setRemoteDescription(L),this._mapMidTransceiver.set(T,d),{localId:T,rtpParameters:f,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),R.debug("stopSending() [localId:%s]",e),this._closed)return;let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}let n=await this._pc.createOffer();R.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);let a={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),R.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let i=await this._pc.createOffer();R.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),R.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";let i=await this._pc.createOffer();R.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?R.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):R.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),R.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{u<=t?l.active=!0:l.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();R.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),R.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{n.encodings[u]={...l,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();R.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};R.debug("sendDataChannel() [options:%o]",o);let l=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ci.MIS,!this._hasDataChannelMediaSection){let d=await this._pc.createOffer(),p=he.parse(d.sdp),h=p.media.find(g=>g.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),R.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});let m={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}let u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:l,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();let t=[],i=new Map;for(let l of e){let{trackId:u,kind:d,rtpParameters:p,streamId:h}=l;R.debug("receive() [trackId:%s, kind:%s]",u,d);let m=p.mid??String(this._mapMidTransceiver.size);i.set(u,m);let{msidStreamId:g}=Fr.getMsidStreamIdAndTrackId(p.msid);this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??g??p.rtcp?.cname??"-",trackId:u})}let n={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(let l of e){let{trackId:u,onRtpReceiver:d}=l;if(d){let p=i.get(u),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let a=await this._pc.createAnswer(),o=he.parse(a.sdp);for(let l of e){let{trackId:u,rtpParameters:d}=l,p=i.get(u),h=o.media.find(m=>String(m.mid)===p);wt.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}a={type:"answer",sdp:he.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),R.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let l of e){let{trackId:u}=l,d=i.get(u),p=this._pc.getTransceivers().find(h=>h.mid===d);if(p)this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(let n of e){R.debug("stopReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();R.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(let n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){R.debug("pauseReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();R.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){R.debug("resumeReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();R.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();let{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l}=e,u={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l,protocol:i};R.debug("receiveDataChannel() [options:%o]",u);let d=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);let h=await this._pc.createAnswer();if(!this._transportReady){let m=he.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}R.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=he.parse(this._pc.localDescription.sdp));let i=wt.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new $a.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Kt.Chrome111=Ar});var ui=x(Wt=>{"use strict";Object.defineProperty(Wt,"__esModule",{value:!0});Wt.Chrome74=void 0;var X=ue(),Va=U(),Ha=G(),bt=se(),Ga=W(),Qa=xe(),Ka=tt(),yt=rt(),qr=st(),zr=it(),S=new Va.Logger("Chrome74"),pi="Chrome74",li={OS:1024,MIS:1024},$r=class r extends Ha.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,getSendExtendedRtpCapabilities:d}){super();c(this,"_closed",!1);c(this,"_direction");c(this,"_remoteSdp");c(this,"_getSendExtendedRtpCapabilities");c(this,"_forcedLocalDtlsRole");c(this,"_pc");c(this,"_mapMidTransceiver",new Map);c(this,"_sendStream",new MediaStream);c(this,"_hasDataChannelMediaSection",!1);c(this,"_nextSendSctpStreamId",0);c(this,"_transportReady",!1);c(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});c(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});c(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});c(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});S.debug("constructor()"),this._direction=e,this._remoteSdp=new Ka.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:l??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(S.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:pi,factory:e=>new r(e),getNativeRtpCapabilities:async()=>{S.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=await e.createOffer();try{e.close()}catch{}e=void 0;let i=X.parse(t.sdp);return r.getLocalRtpCapabilities(i)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(S.debug("getNativeSctpCapabilities()"),{numStreams:li})}}static getLocalRtpCapabilities(e,t=[]){let i=yt.extractRtpCapabilities({sdpObject:e});bt.validateAndNormalizeRtpCapabilities(i),zr.addNackSupportForOpus(i);for(let n of t)zr.addHeaderExtensionSupport(i,n);return i}get name(){return pi}close(){if(S.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),S.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),S.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});S.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();S.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:i,codecOptions:n,headerExtensionOptions:a,codec:o}){this.assertNotClosed(),this.assertSendDirection(),S.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),i&&i.length>1&&i.forEach((k,j)=>{k.rid=`r${j}`});let l=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i}),d=await this._pc.createOffer(),p=X.parse(d.sdp);p.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let h=[];h.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});let m=r.getLocalRtpCapabilities(p,h),g=this._getSendExtendedRtpCapabilities(m),v=bt.getSendingRtpParameters(e.kind,g);v.codecs=bt.reduceCodecs(v.codecs,o);let f=bt.getSendingRemoteRtpParameters(e.kind,g);f.codecs=bt.reduceCodecs(f.codecs,o),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p});let _=!1,T=(0,Qa.parse)((i??[{}])[0].scalabilityMode),P;i?.length===1&&T.spatialLayers>1&&v.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(S.debug("send() | enabling legacy simulcast for VP9 SVC"),_=!0,p=X.parse(d.sdp),P=p.media[l.idx],qr.addLegacySimulcast({offerMediaObject:P,numStreams:T.spatialLayers}),d={type:"offer",sdp:X.write(p)}),S.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),a?.absCaptureTime&&(P=p.media[l.idx],yt.addHeaderExtension({offerMediaObject:P,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:f.headerExtensions.find(k=>k.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),d={type:"offer",sdp:X.write(p)}),await this._pc.setLocalDescription(d);let L=u.mid;if(v.mid=L,p=X.parse(this._pc.localDescription.sdp),P=p.media[l.idx],v.rtcp.cname=yt.getCname({offerMediaObject:P}),v.msid=`${t??this._sendStream.id} ${e.id}`,!i)v.encodings=qr.getRtpEncodings({offerMediaObject:P});else if(i.length===1){let k=qr.getRtpEncodings({offerMediaObject:P});Object.assign(k[0],i[0]),_&&(k=[k[0]]),v.encodings=k}else v.encodings=i;if(v.encodings.length>1&&(v.codecs[0].mimeType.toLowerCase()==="video/vp8"||v.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let k of v.encodings)k.scalabilityMode?k.scalabilityMode=`L1T${T.temporalLayers}`:k.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:P,reuseMid:l.reuseMid,offerRtpParameters:v,answerRtpParameters:f,codecOptions:n});let O={type:"answer",sdp:this._remoteSdp.getSdp()};return S.debug("send() | calling pc.setRemoteDescription() [answer:%o]",O),await this._pc.setRemoteDescription(O),this._mapMidTransceiver.set(L,u),{localId:L,rtpParameters:v,rtpSender:u.sender}}async stopSending(e){if(this.assertSendDirection(),S.debug("stopSending() [localId:%s]",e),this._closed)return;let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}let n=await this._pc.createOffer();S.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);let a={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),S.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let i=await this._pc.createOffer();S.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),S.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";let i=await this._pc.createOffer();S.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?S.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):S.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),S.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{u<=t?l.active=!0:l.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();S.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),S.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{n.encodings[u]={...l,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();S.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};S.debug("sendDataChannel() [options:%o]",o);let l=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%li.MIS,!this._hasDataChannelMediaSection){let d=await this._pc.createOffer(),p=X.parse(d.sdp),h=p.media.find(g=>g.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),S.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});let m={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}let u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:l,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();let t=[],i=new Map;for(let l of e){let{trackId:u,kind:d,rtpParameters:p,streamId:h}=l;S.debug("receive() [trackId:%s, kind:%s]",u,d);let m=p.mid??String(this._mapMidTransceiver.size);i.set(u,m);let{msidStreamId:g}=zr.getMsidStreamIdAndTrackId(p.msid);this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??g??p.rtcp?.cname??"-",trackId:u})}let n={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer(),o=X.parse(a.sdp);for(let l of e){let{trackId:u,rtpParameters:d}=l,p=i.get(u),h=o.media.find(m=>String(m.mid)===p);yt.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}a={type:"answer",sdp:X.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),S.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let l of e){let{trackId:u}=l,d=i.get(u),p=this._pc.getTransceivers().find(h=>h.mid===d);if(p)this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(let n of e){S.debug("stopReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();S.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(let n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){S.debug("pauseReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();S.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){S.debug("resumeReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();S.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();let{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l}=e,u={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l,protocol:i};S.debug("receiveDataChannel() [options:%o]",u);let d=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);let h=await this._pc.createAnswer();if(!this._transportReady){let m=X.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}S.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=X.parse(this._pc.localDescription.sdp));let i=yt.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Ga.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Wt.Chrome74=$r});var _i=x(Yt=>{"use strict";Object.defineProperty(Yt,"__esModule",{value:!0});Yt.Firefox120=void 0;var ve=ue(),Wa=G(),Ja=U(),hi=W(),St=se(),Ya=xe(),Za=tt(),Jt=rt(),mi=st(),Xa=it(),E=new Ja.Logger("Firefox120"),fi="Firefox120",gi={OS:16,MIS:2048},Br=class r extends Wa.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,getSendExtendedRtpCapabilities:d}){super();c(this,"_closed",!1);c(this,"_direction");c(this,"_remoteSdp");c(this,"_getSendExtendedRtpCapabilities");c(this,"_pc");c(this,"_mapMidTransceiver",new Map);c(this,"_sendStream",new MediaStream);c(this,"_hasDataChannelMediaSection",!1);c(this,"_nextSendSctpStreamId",0);c(this,"_transportReady",!1);c(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});c(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});c(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});c(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});E.debug("constructor()"),this._direction=e,this._remoteSdp=new Za.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._getSendExtendedRtpCapabilities=d,this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:l??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(E.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:fi,factory:e=>new r(e),getNativeRtpCapabilities:async()=>{E.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");let n=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"}),e.addTransceiver(n,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});let a=await e.createOffer();try{t.remove()}catch{}try{n.stop()}catch{}try{e.close()}catch{}e=void 0;let o=ve.parse(a.sdp);return r.getLocalRtpCapabilities(o)}catch(a){try{t.remove()}catch{}try{n.stop()}catch{}try{e?.close()}catch{}throw e=void 0,a}},getNativeSctpCapabilities:async()=>(E.debug("getNativeSctpCapabilities()"),{numStreams:gi})}}static getLocalRtpCapabilities(e){let t=Jt.extractRtpCapabilities({sdpObject:e});return St.validateAndNormalizeRtpCapabilities(t),t}get name(){return fi}close(){if(E.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){throw this.assertNotClosed(),new hi.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),E.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});E.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();E.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:i,codecOptions:n,codec:a,onRtpSender:o}){this.assertNotClosed(),this.assertSendDirection(),E.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),i&&i.length>1&&i.forEach((P,L)=>{P.rid=`r${L}`});let l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i});o&&o(l.sender);let u=await this._pc.createOffer(),d=ve.parse(u.sdp);d.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let p=r.getLocalRtpCapabilities(d),h=this._getSendExtendedRtpCapabilities(p),m=St.getSendingRtpParameters(e.kind,h);m.codecs=St.reduceCodecs(m.codecs,a);let g=St.getSendingRemoteRtpParameters(e.kind,h);g.codecs=St.reduceCodecs(g.codecs,a),this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:d});let v=(0,Ya.parse)((i??[{}])[0].scalabilityMode);E.debug("send() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u);let f=l.mid;m.mid=f,d=ve.parse(this._pc.localDescription.sdp);let _=d.media[d.media.length-1];if(m.rtcp.cname=Jt.getCname({offerMediaObject:_}),m.msid=`${t??this._sendStream.id} ${e.id}`,!i)m.encodings=mi.getRtpEncodings({offerMediaObject:_});else if(i.length===1){let P=mi.getRtpEncodings({offerMediaObject:_});Object.assign(P[0],i[0]),m.encodings=P}else m.encodings=i;if(m.encodings.length>1&&(m.codecs[0].mimeType.toLowerCase()==="video/vp8"||m.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let P of m.encodings)P.scalabilityMode?P.scalabilityMode=`L1T${v.temporalLayers}`:P.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:_,offerRtpParameters:m,answerRtpParameters:g,codecOptions:n});let T={type:"answer",sdp:this._remoteSdp.getSdp()};return E.debug("send() | calling pc.setRemoteDescription() [answer:%o]",T),await this._pc.setRemoteDescription(T),this._mapMidTransceiver.set(f,l),{localId:f,rtpParameters:m,rtpSender:l.sender}}async stopSending(e){if(this.assertSendDirection(),E.debug("stopSending() [localId:%s]",e),this._closed)return;let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);let i=await this._pc.createOffer();E.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),E.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let i=await this._pc.createOffer();E.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),E.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);let i=await this._pc.createOffer();E.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?E.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):E.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),E.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated transceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{u<=t?l.active=!0:l.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();E.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),E.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{n.encodings[u]={...l,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();E.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};E.debug("sendDataChannel() [options:%o]",o);let l=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%gi.MIS,!this._hasDataChannelMediaSection){let d=await this._pc.createOffer(),p=ve.parse(d.sdp),h=p.media.find(g=>g.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:p}),E.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});let m={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}let u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:l,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();let t=[],i=new Map;for(let l of e){let{trackId:u,kind:d,rtpParameters:p,streamId:h}=l;E.debug("receive() [trackId:%s, kind:%s]",u,d);let m=p.mid??String(this._mapMidTransceiver.size);i.set(u,m);let{msidStreamId:g}=Xa.getMsidStreamIdAndTrackId(p.msid);this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??g??p.rtcp?.cname??"-",trackId:u})}let n={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(let l of e){let{trackId:u,onRtpReceiver:d}=l;if(d){let p=i.get(u),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let a=await this._pc.createAnswer(),o=ve.parse(a.sdp);for(let l of e){let{trackId:u,rtpParameters:d}=l,p=i.get(u),h=o.media.find(m=>String(m.mid)===p);Jt.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h}),a={type:"answer",sdp:ve.write(o)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:o}),E.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let l of e){let{trackId:u}=l,d=i.get(u),p=this._pc.getTransceivers().find(h=>h.mid===d);if(!p)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(let n of e){E.debug("stopReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();E.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(let n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){E.debug("pauseReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();E.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){E.debug("resumeReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();E.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();let{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l}=e,u={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l,protocol:i};E.debug("receiveDataChannel() [options:%o]",u);let d=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);let h=await this._pc.createAnswer();if(!this._transportReady){let m=ve.parse(h.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:m})}E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ve.parse(this._pc.localDescription.sdp));let i=Jt.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new hi.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Yt.Firefox120=Br});var yi=x(Zt=>{"use strict";Object.defineProperty(Zt,"__esModule",{value:!0});Zt.Safari12=void 0;var ee=ue(),eo=G(),to=U(),Ct=se(),ro=W(),so=xe(),io=tt(),Rt=rt(),vi=st(),Ur=it(),C=new to.Logger("Safari12"),wi="Safari12",bi={OS:1024,MIS:1024},Vr=class r extends eo.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,getSendExtendedRtpCapabilities:d}){super();c(this,"_closed",!1);c(this,"_direction");c(this,"_remoteSdp");c(this,"_getSendExtendedRtpCapabilities");c(this,"_forcedLocalDtlsRole");c(this,"_pc");c(this,"_mapMidTransceiver",new Map);c(this,"_sendStream",new MediaStream);c(this,"_hasDataChannelMediaSection",!1);c(this,"_nextSendSctpStreamId",0);c(this,"_transportReady",!1);c(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});c(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});c(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});c(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});C.debug("constructor()"),this._direction=e,this._remoteSdp=new io.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:l??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u}),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",p=>{this.emit("@icecandidateerror",p)}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(C.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:wi,factory:e=>new r(e),getNativeRtpCapabilities:async()=>{C.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=await e.createOffer();try{e.close()}catch{}e=void 0;let i=ee.parse(t.sdp);return r.getLocalRtpCapabilities(i)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(C.debug("getNativeSctpCapabilities()"),{numStreams:bi})}}static getLocalRtpCapabilities(e,t=[]){let i=Rt.extractRtpCapabilities({sdpObject:e});Ct.validateAndNormalizeRtpCapabilities(i),Ur.addNackSupportForOpus(i);for(let n of t)Ur.addHeaderExtensionSupport(i,n);return i}get name(){return wi}close(){if(C.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),C.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),C.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});C.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();C.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:i,codecOptions:n,headerExtensionOptions:a,codec:o,onRtpSender:l}){this.assertNotClosed(),this.assertSendDirection(),C.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t);let u=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});l&&l(d.sender);let p=await this._pc.createOffer(),h=ee.parse(p.sdp);h.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let m=[];m.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});let g=r.getLocalRtpCapabilities(h,m),v=this._getSendExtendedRtpCapabilities(g),f=Ct.getSendingRtpParameters(e.kind,v);f.codecs=Ct.reduceCodecs(f.codecs,o);let _=Ct.getSendingRemoteRtpParameters(e.kind,v);_.codecs=Ct.reduceCodecs(_.codecs,o);let T;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:h});let P=(0,so.parse)((i??[{}])[0].scalabilityMode);i&&i.length>1&&(C.debug("send() | enabling legacy simulcast"),h=ee.parse(p.sdp),T=h.media[u.idx],vi.addLegacySimulcast({offerMediaObject:T,numStreams:i.length}),p={type:"offer",sdp:ee.write(h)}),a?.absCaptureTime&&(T=h.media[u.idx],Rt.addHeaderExtension({offerMediaObject:T,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:_.headerExtensions.find(k=>k.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),p={type:"offer",sdp:ee.write(h)}),C.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);let L=d.mid;if(f.mid=L,h=ee.parse(this._pc.localDescription.sdp),T=h.media[u.idx],f.rtcp.cname=Rt.getCname({offerMediaObject:T}),f.msid=`${t??this._sendStream.id} ${e.id}`,f.encodings=vi.getRtpEncodings({offerMediaObject:T}),i)for(let k=0;k<f.encodings.length;++k)i[k]&&Object.assign(f.encodings[k],i[k]);if(f.encodings.length>1&&(f.codecs[0].mimeType.toLowerCase()==="video/vp8"||f.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let k of f.encodings)k.scalabilityMode?k.scalabilityMode=`L1T${P.temporalLayers}`:k.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:T,reuseMid:u.reuseMid,offerRtpParameters:f,answerRtpParameters:_,codecOptions:n});let O={type:"answer",sdp:this._remoteSdp.getSdp()};return C.debug("send() | calling pc.setRemoteDescription() [answer:%o]",O),await this._pc.setRemoteDescription(O),this._mapMidTransceiver.set(L,d),{localId:L,rtpParameters:f,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;C.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}let n=await this._pc.createOffer();C.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);let a={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),C.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let i=await this._pc.createOffer();C.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),C.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);let i=await this._pc.createOffer();C.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?C.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):C.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),C.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{u<=t?l.active=!0:l.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();C.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),C.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{n.encodings[u]={...l,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();C.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};C.debug("sendDataChannel() [options:%o]",o);let l=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%bi.MIS,!this._hasDataChannelMediaSection){let d=await this._pc.createOffer(),p=ee.parse(d.sdp),h=p.media.find(g=>g.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),C.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});let m={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}let u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:l,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();let t=[],i=new Map;for(let l of e){let{trackId:u,kind:d,rtpParameters:p,streamId:h}=l;C.debug("receive() [trackId:%s, kind:%s]",u,d);let m=p.mid??String(this._mapMidTransceiver.size);i.set(u,m);let{msidStreamId:g}=Ur.getMsidStreamIdAndTrackId(p.msid);this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??g??p.rtcp?.cname??"-",trackId:u})}let n={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(let l of e){let{trackId:u,onRtpReceiver:d}=l;if(d){let p=i.get(u),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let a=await this._pc.createAnswer(),o=ee.parse(a.sdp);for(let l of e){let{trackId:u,rtpParameters:d}=l,p=i.get(u),h=o.media.find(m=>String(m.mid)===p);Rt.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}a={type:"answer",sdp:ee.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),C.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let l of e){let{trackId:u}=l,d=i.get(u),p=this._pc.getTransceivers().find(h=>h.mid===d);if(!p)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(let n of e){C.debug("stopReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();C.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(let n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){C.debug("pauseReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();C.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){C.debug("resumeReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();C.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();let{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l}=e,u={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l,protocol:i};C.debug("receiveDataChannel() [options:%o]",u);let d=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);let h=await this._pc.createAnswer();if(!this._transportReady){let m=ee.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}C.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ee.parse(this._pc.localDescription.sdp));let i=Rt.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new ro.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Zt.Safari12=Vr});var Ri=x(Xt=>{"use strict";Object.defineProperty(Xt,"__esModule",{value:!0});Xt.ReactNative106=void 0;var te=ue(),no=G(),ao=U(),Et=se(),oo=W(),co=xe(),po=tt(),Tt=rt(),Hr=st(),Gr=it(),y=new ao.Logger("ReactNative106"),Si="ReactNative106",Ci={OS:1024,MIS:1024},Qr=class r extends no.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,getSendExtendedRtpCapabilities:d}){super();c(this,"_closed",!1);c(this,"_direction");c(this,"_remoteSdp");c(this,"_getSendExtendedRtpCapabilities");c(this,"_forcedLocalDtlsRole");c(this,"_pc");c(this,"_mapMidTransceiver",new Map);c(this,"_sendStream",new MediaStream);c(this,"_hasDataChannelMediaSection",!1);c(this,"_nextSendSctpStreamId",0);c(this,"_transportReady",!1);c(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});c(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});c(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});c(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});y.debug("constructor()"),this._direction=e,this._remoteSdp=new po.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:l??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(y.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:Si,factory:e=>new r(e),getNativeRtpCapabilities:async()=>{y.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=await e.createOffer();try{e.close()}catch{}e=void 0;let i=te.parse(t.sdp);return r.getLocalRtpCapabilities(i)}catch(t){try{e?.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(y.debug("getNativeSctpCapabilities()"),{numStreams:Ci})}}static getLocalRtpCapabilities(e,t=[]){let i=Tt.extractRtpCapabilities({sdpObject:e});Et.validateAndNormalizeRtpCapabilities(i),Gr.addNackSupportForOpus(i);for(let n of t)Gr.addHeaderExtensionSupport(i,n);return i}get name(){return Si}close(){if(y.debug("close()"),!this._closed){this._closed=!0,this._sendStream.release(!1);try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),y.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),y.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});y.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();y.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,streamId:t,encodings:i,codecOptions:n,headerExtensionOptions:a,codec:o,onRtpSender:l}){this.assertNotClosed(),this.assertSendDirection(),y.debug("send() [kind:%s, track.id:%s, streamId:%s]",e.kind,e.id,t),i&&i.length>1&&i.forEach((j,be)=>{j.rid=`r${be}`});let u=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i});l&&l(d.sender);let p=await this._pc.createOffer(),h=te.parse(p.sdp);h.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let m=[];m.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:e.kind,direction:"sendonly"});let g=r.getLocalRtpCapabilities(h,m),v=this._getSendExtendedRtpCapabilities(g),f=Et.getSendingRtpParameters(e.kind,v);f.codecs=Et.reduceCodecs(f.codecs,o);let _=Et.getSendingRemoteRtpParameters(e.kind,v);_.codecs=Et.reduceCodecs(_.codecs,o),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:h});let T=!1,P=(0,co.parse)((i??[{}])[0].scalabilityMode),L;i?.length===1&&P.spatialLayers>1&&f.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(y.debug("send() | enabling legacy simulcast for VP9 SVC"),T=!0,h=te.parse(p.sdp),L=h.media[u.idx],Hr.addLegacySimulcast({offerMediaObject:L,numStreams:P.spatialLayers}),p={type:"offer",sdp:te.write(h)}),a?.absCaptureTime&&(L=h.media[u.idx],Tt.addHeaderExtension({offerMediaObject:L,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:_.headerExtensions.find(j=>j.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),p={type:"offer",sdp:te.write(h)}),y.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);let O=d.mid??void 0;if(O||y.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),f.mid=O,h=te.parse(this._pc.localDescription.sdp),L=h.media[u.idx],f.rtcp.cname=Tt.getCname({offerMediaObject:L}),f.msid=`${t??this._sendStream.id} ${e.id}`,!i)f.encodings=Hr.getRtpEncodings({offerMediaObject:L});else if(i.length===1){let j=Hr.getRtpEncodings({offerMediaObject:L});Object.assign(j[0],i[0]),T&&(j=[j[0]]),f.encodings=j}else f.encodings=i;if(f.encodings.length>1&&(f.codecs[0].mimeType.toLowerCase()==="video/vp8"||f.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let j of f.encodings)j.scalabilityMode?j.scalabilityMode=`L1T${P.temporalLayers}`:j.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:L,reuseMid:u.reuseMid,offerRtpParameters:f,answerRtpParameters:_,codecOptions:n});let k={type:"answer",sdp:this._remoteSdp.getSdp()};return y.debug("send() | calling pc.setRemoteDescription() [answer:%o]",k),await this._pc.setRemoteDescription(k),O||(O=d.mid,f.mid=O),this._mapMidTransceiver.set(O,d),{localId:O,rtpParameters:f,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;y.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}let n=await this._pc.createOffer();y.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);let a={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),y.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let i=await this._pc.createOffer();y.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),y.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";let i=await this._pc.createOffer();y.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?y.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):y.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),y.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{u<=t?l.active=!0:l.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();y.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),y.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((l,u)=>{n.encodings[u]={...l,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);let a=await this._pc.createOffer();y.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);let o={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};y.debug("sendDataChannel() [options:%o]",o);let l=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ci.MIS,!this._hasDataChannelMediaSection){let d=await this._pc.createOffer(),p=te.parse(d.sdp),h=p.media.find(g=>g.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),y.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});let m={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}let u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:l,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();let t=[],i=new Map;for(let l of e){let{trackId:u,kind:d,rtpParameters:p,streamId:h}=l;y.debug("receive() [trackId:%s, kind:%s]",u,d);let m=p.mid??String(this._mapMidTransceiver.size);i.set(u,m);let{msidStreamId:g}=Gr.getMsidStreamIdAndTrackId(p.msid);this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??g??p.rtcp?.cname??"-",trackId:u})}let n={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(let l of e){let{trackId:u,onRtpReceiver:d}=l;if(d){let p=i.get(u),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let a=await this._pc.createAnswer(),o=te.parse(a.sdp);for(let l of e){let{trackId:u,rtpParameters:d}=l,p=i.get(u),h=o.media.find(m=>String(m.mid)===p);Tt.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}a={type:"answer",sdp:te.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),y.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let l of e){let{trackId:u}=l,d=i.get(u),p=this._pc.getTransceivers().find(h=>h.mid===d);if(p)this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(let n of e){y.debug("stopReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();y.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(let n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){y.debug("pauseReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();y.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(let n of e){y.debug("resumeReceiving() [localId:%s]",n);let a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let i=await this._pc.createAnswer();y.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();let{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l}=e,u={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:l,protocol:i};y.debug("receiveDataChannel() [options:%o]",u);let d=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);let h=await this._pc.createAnswer();if(!this._transportReady){let m=te.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=te.parse(this._pc.localDescription.sdp));let i=Tt.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new oo.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Xt.ReactNative106=Qr});var ki=x(nt=>{"use strict";Object.defineProperty(nt,"__esModule",{value:!0});nt.Device=void 0;nt.detectDevice=Ei;nt.detectDeviceAsync=Ti;var lo=U(),uo=G(),De=W(),Kr=Ce(),me=se(),ho=Ks(),mo=di(),fo=ui(),go=_i(),_o=yi(),vo=Ri(),b=new lo.Logger("Device");function Ei(r,s){return b.debug("detectDevice()"),!r&&typeof navigator=="object"&&(r=navigator.userAgent),!s&&typeof navigator=="object"&&(s=navigator.userAgentData),xi(r,s)}async function Ti(r,s){return b.debug("detectDeviceAsync()"),!r&&typeof navigator=="object"&&(r=navigator.userAgent),!s&&typeof navigator=="object"&&(s=navigator.userAgentData),xi(r,s)}var Wr=class r{constructor({handlerName:s,handlerFactory:e}={}){c(this,"_handlerFactory");c(this,"_handlerName");c(this,"_loaded",!1);c(this,"_getSendExtendedRtpCapabilities");c(this,"_recvRtpCapabilities");c(this,"_canProduceByKind",{audio:!1,video:!1});c(this,"_sctpCapabilities");c(this,"_observer",new uo.EnhancedEventEmitter);if(b.debug("constructor()"),s&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(e)this._handlerFactory=e;else{if(s)b.debug("constructor() | handler given: %s",s);else if(s=Ei(),s)b.debug("constructor() | detected handler: %s",s);else throw new De.UnsupportedError("device not supported");switch(s){case"Chrome111":{this._handlerFactory=mo.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=fo.Chrome74.createFactory();break}case"Firefox120":{this._handlerFactory=go.Firefox120.createFactory();break}case"Safari12":{this._handlerFactory=_o.Safari12.createFactory();break}case"ReactNative106":{this._handlerFactory=vo.ReactNative106.createFactory();break}default:throw new TypeError(`unknown handlerName "${s}"`)}}this._handlerName=this._handlerFactory.name}static async factory({handlerName:s,handlerFactory:e}={}){if(b.debug("factory()"),s&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(!s&&!e&&(s=await Ti(),!s))throw new De.UnsupportedError("device not supported");return new r({handlerName:s,handlerFactory:e})}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new De.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new De.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:s,preferLocalCodecsOrder:e=!1}){if(b.debug("load() [routerRtpCapabilities:%o]",s),this._loaded)throw new De.InvalidStateError("already loaded");let t=Kr.clone(s);me.validateAndNormalizeRtpCapabilities(t);let{getNativeRtpCapabilities:i,getNativeSctpCapabilities:n}=this._handlerFactory,a=Kr.clone(await i());me.validateAndNormalizeRtpCapabilities(a),b.debug("load() | got native RTP capabilities:%o",a),this._getSendExtendedRtpCapabilities=l=>Kr.clone(me.getExtendedRtpCapabilities(l,t,e));let o=me.getExtendedRtpCapabilities(a,t,!1);this._recvRtpCapabilities=me.getRecvRtpCapabilities(o),me.validateAndNormalizeRtpCapabilities(this._recvRtpCapabilities),b.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._canProduceByKind.audio=me.canSend("audio",this._recvRtpCapabilities),this._canProduceByKind.video=me.canSend("video",this._recvRtpCapabilities),this._sctpCapabilities=await n(),me.validateSctpCapabilities(this._sctpCapabilities),b.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),b.debug("load() succeeded"),this._loaded=!0}canProduce(s){if(this._loaded){if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind "${s}"`)}else throw new De.InvalidStateError("not loaded");return this._canProduceByKind[s]}createSendTransport({id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:l,appData:u}){return b.debug("createSendTransport()"),this.createTransport({direction:"send",id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:l,appData:u})}createRecvTransport({id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:l,appData:u}){return b.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:l,appData:u})}createTransport({direction:s,id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,appData:d}){if(this._loaded){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(d&&typeof d!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new De.InvalidStateError("not loaded");let p=new ho.Transport({direction:s,id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:l,additionalSettings:u,appData:d,handlerFactory:this._handlerFactory,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities,recvRtpCapabilities:this._recvRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",p),p}};nt.Device=Wr;function xi(r,s){b.debug('detectDeviceImpl() [userAgent:"%s", userAgentData:%o]',r,s);let e=wo(r,s);if(e){if(e>=111)return b.debug("detectDeviceImpl() | using Chrome111 handler"),"Chrome111";if(e>=74)return b.debug("detectDeviceImpl() | using Chrome74 handler"),"Chrome74";b.warn("detectDeviceImpl() | unsupported Chromium based browser/version");return}let t=bo(r);if(t){if(t>=120)return b.debug("detectDeviceImpl() | using Firefox120 handler"),"Firefox120";b.warn("detectDeviceImpl() | unsupported Firefox browser/version");return}let i=yo(r);if(i){if(i>=605)return b.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";b.warn("detectDeviceImpl() | unsupported desktop Safari browser/version");return}let n=So(r);if(n){if(n>=605)return b.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";b.warn("detectDeviceImpl() | unsupported iOS Safari based browser/version");return}if(xt()){if(typeof RTCPeerConnection<"u"&&typeof RTCRtpTransceiver<"u")return b.debug("detectDeviceImpl() | using ReactNative106 handler"),"ReactNative106";b.warn("detectDeviceImpl() | unsupported react-native-webrtc version without RTCPeerConnection or RTCRtpTransceiver, forgot to call registerGlobals() on it?");return}b.warn('detectDeviceImpl() | device not supported [userAgent:"%s", userAgentData:%o]',r,s)}function wo(r,s){if(b.debug("getChromiumMajorVersion()"),er(r,s)){b.debug("getChromiumMajorVersion() | this is iOS => undefined");return}if(xt()){b.debug("getChromiumMajorVersion() | this is React-Native => undefined");return}if(s){let t=(s.brands??[]).find(i=>i.brand==="Chromium");if(t){let i=Number(t.version);return b.debug(`getChromiumMajorVersion() | Chromium major version based on NavigatorUAData => ${i}`),i}}let e=r?.match(/\b(?:Chrome|Chromium)\/(\w+)/i);if(e?.[1]){let t=Number(e[1]);return b.debug(`getChromiumMajorVersion() | Chromium major version based on User-Agent => ${t}`),t}b.debug("getChromiumMajorVersion() | this is not Chromium => undefined")}function bo(r){if(b.debug("getFirefoxMajorVersion()"),er(r)){b.debug("getFirefoxMajorVersion() | this is iOS => undefined");return}if(xt()){b.debug("getFirefoxMajorVersion() | this is React-Native => undefined");return}let s=r?.match(/\bFirefox\/(\w+)/i);if(s?.[1]){let e=Number(s[1]);return b.debug(`getFirefoxMajorVersion() | Firefox major version based on User-Agent => ${e}`),e}b.debug("getFirefoxMajorVersion() | this is not Firefox => undefined")}function yo(r){if(b.debug("getMacOSWebKitMajorVersion()"),er(r)){b.debug("getMacOSWebKitMajorVersion() | this is iOS => undefined");return}if(xt()){b.debug("getMacOSWebKitMajorVersion() | this is React-Native => undefined");return}if(!(r&&/\bSafari\b/i.test(r)&&!/\bChrome\b/i.test(r)&&!/\bChromium\b/i.test(r)&&!/\bFirefox\b/i.test(r))){b.debug("getMacOSWebKitMajorVersion() | this is not Safari => undefined");return}let e=r.match(/AppleWebKit\/(\w+)/i);if(e?.[1]){let t=Number(e[1]);return b.debug(`getMacOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${t}`),t}b.debug("getMacOSWebKitMajorVersion() | this is not WebKit => undefined")}function So(r){if(b.debug("getIOSWebKitMajorVersion()"),!er(r)){b.debug("getIOSWebKitMajorVersion() | this is not iOS => undefined");return}if(xt()){b.debug("getIOSWebKitMajorVersion() | this is React-Native => undefined");return}let s=r?.match(/AppleWebKit\/(\w+)/i);if(s?.[1]){let e=Number(s[1]);return b.debug(`getIOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${e}`),e}b.debug("getIOSWebKitMajorVersion() | this is not WebKit => undefined")}function er(r,s){return b.debug("isIOS()"),s?.platform==="iOS"?(b.debug("isIOS() | this is iOS based on NavigatorUAData.platform => true"),!0):s?.platform?(b.debug("isIOS() | this is not iOS based on NavigatorUAData.platform => false"),!1):r&&/iPad|iPhone|iPod/.test(r)?(b.debug("isIOS() | this is iOS based on User-Agent => true"),!0):typeof navigator=="object"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1?(b.debug("isIOS() | this is iPadOS 13+ based on User-Agent => true"),!0):(b.debug("isIOS() | this is not iOS => false"),!1)}function xt(){return b.debug("isReactNative()"),typeof navigator=="object"&&navigator.product==="ReactNative"?(b.debug("isReactNative() | this is React-Native based on navigator.product"),!0):(b.debug("isReactNative() | this is not React-Native => false"),!1)}});var Pi=x(Di=>{var Pe=256,rr=[],tr;for(;Pe--;)rr[Pe]=(Pe+256).toString(16).substring(1);function Co(){var r=0,s,e="";if(!tr||Pe+16>256){for(tr=Array(r=256);r--;)tr[r]=256*Math.random()|0;r=Pe=0}for(;r<16;r++)s=tr[Pe+r],r==6?e+=rr[s&15|64]:r==8?e+=rr[s&63|128]:e+=rr[s],r&1&&r>1&&r<11&&(e+="-");return Pe++,e}Di.v4=Co});var Li=x(sr=>{"use strict";Object.defineProperty(sr,"__esModule",{value:!0});sr.FakeEventTarget=void 0;var Jr=class{constructor(){c(this,"listeners",{})}addEventListener(s,e,t){e&&(this.listeners[s]=this.listeners[s]??[],this.listeners[s].push({callback:typeof e=="function"?e:e.handleEvent,once:typeof t=="object"&&t.once===!0}))}removeEventListener(s,e,t){this.listeners[s]&&e&&(this.listeners[s]=this.listeners[s].filter(i=>i.callback!==(typeof e=="function"?e:e.handleEvent)))}dispatchEvent(s){if(!s||typeof s.type!="string")throw new Error("invalid event object");let e=this.listeners[s.type];if(!e)return!0;for(let t of[...e]){try{t.callback.call(this,s)}catch(i){setTimeout(()=>{throw i},0)}t.once&&this.removeEventListener(s.type,t.callback)}return!s.defaultPrevented}};sr.FakeEventTarget=Jr});var Ii=x(ir=>{"use strict";Object.defineProperty(ir,"__esModule",{value:!0});ir.FakeEvent=void 0;var Yr=class{constructor(s,e={}){c(this,"NONE",0);c(this,"CAPTURING_PHASE",1);c(this,"AT_TARGET",2);c(this,"BUBBLING_PHASE",3);c(this,"type");c(this,"bubbles");c(this,"cancelable");c(this,"defaultPrevented",!1);c(this,"composed",!1);c(this,"currentTarget",null);c(this,"eventPhase",this.NONE);c(this,"isTrusted",!0);c(this,"target",null);c(this,"timeStamp",0);c(this,"cancelBubble",!1);c(this,"returnValue",!0);c(this,"srcElement",null);this.type=s,this.bubbles=e.bubbles??!1,this.cancelable=e.cancelable??!1}preventDefault(){this.cancelable&&(this.defaultPrevented=!0)}stopPropagation(){}stopImmediatePropagation(){}composedPath(){return[]}initEvent(s,e,t){}};ir.FakeEvent=Yr});var Mi=x(Zr=>{"use strict";Object.defineProperty(Zr,"__esModule",{value:!0});Zr.clone=Ro;function Ro(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}});var Ni=x(ar=>{"use strict";Object.defineProperty(ar,"__esModule",{value:!0});ar.FakeMediaStreamTrack=void 0;var Oi=Pi(),Eo=Li(),at=Ii(),nr=Mi(),kt,ot,ct,oe,we,ce,Le,dt,Ie,pt,Me,Oe,Ne,je,Fe,Ae,es=class es extends Eo.FakeEventTarget{constructor({kind:e,id:t,label:i,contentHint:n,enabled:a,muted:o,readyState:l,capabilities:u,constraints:d,settings:p,data:h}){super();z(this,kt);z(this,ot);z(this,ct);z(this,oe);z(this,we);z(this,ce);z(this,Le);z(this,dt);z(this,Ie);z(this,pt);z(this,Me);z(this,Oe,null);z(this,Ne,null);z(this,je,null);z(this,Fe,null);z(this,Ae,null);N(this,kt,t??(0,Oi.v4)()),N(this,ot,e),N(this,ct,i??""),N(this,Le,n??""),N(this,we,a??!0),N(this,ce,o??!1),N(this,oe,l??"live"),N(this,dt,u??{}),N(this,Ie,d??{}),N(this,pt,p??{}),N(this,Me,h??{})}get id(){return D(this,kt)}get kind(){return D(this,ot)}get label(){return D(this,ct)}get contentHint(){return D(this,Le)}set contentHint(e){N(this,Le,e)}get enabled(){return D(this,we)}set enabled(e){let t=D(this,we)!==e;N(this,we,e),t&&this.dispatchEvent(new at.FakeEvent("enabledchange"))}get muted(){return D(this,ce)}get readyState(){return D(this,oe)}get data(){return D(this,Me)}set data(e){N(this,Me,e)}get onmute(){return D(this,Oe)}set onmute(e){D(this,Oe)&&this.removeEventListener("mute",D(this,Oe)),N(this,Oe,e),e&&this.addEventListener("mute",e)}get onunmute(){return D(this,Ne)}set onunmute(e){D(this,Ne)&&this.removeEventListener("unmute",D(this,Ne)),N(this,Ne,e),e&&this.addEventListener("unmute",e)}get onended(){return D(this,je)}set onended(e){D(this,je)&&this.removeEventListener("ended",D(this,je)),N(this,je,e),e&&this.addEventListener("ended",e)}get onenabledchange(){return D(this,Fe)}set onenabledchange(e){D(this,Fe)&&this.removeEventListener("enabledchange",D(this,Fe)),N(this,Fe,e),e&&this.addEventListener("enabledchange",e)}get onstopped(){return D(this,Ae)}set onstopped(e){D(this,Ae)&&this.removeEventListener("stopped",D(this,Ae)),N(this,Ae,e),e&&this.addEventListener("stopped",e)}addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t,i){super.removeEventListener(e,t,i)}stop(){D(this,oe)!=="ended"&&(N(this,oe,"ended"),this.dispatchEvent(new at.FakeEvent("stopped")))}clone({id:e,data:t}={}){return new es({id:e??(0,Oi.v4)(),kind:D(this,ot),label:D(this,ct),contentHint:D(this,Le),enabled:D(this,we),muted:D(this,ce),readyState:D(this,oe),capabilities:(0,nr.clone)(D(this,dt)),constraints:(0,nr.clone)(D(this,Ie)),settings:(0,nr.clone)(D(this,pt)),data:t??(0,nr.clone)(D(this,Me))})}getCapabilities(){return D(this,dt)}getConstraints(){return D(this,Ie)}async applyConstraints(e={}){return N(this,Ie,e),Promise.resolve()}getSettings(){return D(this,pt)}remoteStop(){D(this,oe)!=="ended"&&(N(this,oe,"ended"),this.dispatchEvent(new at.FakeEvent("stopped")),this.dispatchEvent(new at.FakeEvent("ended")))}remoteMute(){D(this,ce)||(N(this,ce,!0),this.dispatchEvent(new at.FakeEvent("mute")))}remoteUnmute(){D(this,ce)&&(N(this,ce,!1),this.dispatchEvent(new at.FakeEvent("unmute")))}};kt=new WeakMap,ot=new WeakMap,ct=new WeakMap,oe=new WeakMap,we=new WeakMap,ce=new WeakMap,Le=new WeakMap,dt=new WeakMap,Ie=new WeakMap,pt=new WeakMap,Me=new WeakMap,Oe=new WeakMap,Ne=new WeakMap,je=new WeakMap,Fe=new WeakMap,Ae=new WeakMap;var Xr=es;ar.FakeMediaStreamTrack=Xr});var ji=x(or=>{"use strict";Object.defineProperty(or,"__esModule",{value:!0});or.FakeEventTarget=void 0;var ts=class{constructor(){c(this,"listeners",{})}addEventListener(s,e,t){e&&(this.listeners[s]=this.listeners[s]??[],this.listeners[s].push({callback:typeof e=="function"?e:e.handleEvent,once:typeof t=="object"&&t.once===!0}))}removeEventListener(s,e,t){this.listeners[s]&&e&&(this.listeners[s]=this.listeners[s].filter(i=>i.callback!==(typeof e=="function"?e:e.handleEvent)))}dispatchEvent(s){if(!s||typeof s.type!="string")throw new Error("invalid event object");let e=this.listeners[s.type];if(!e)return!0;for(let t of[...e]){try{t.callback.call(this,s)}catch(i){setTimeout(()=>{throw i},0)}t.once&&this.removeEventListener(s.type,t.callback)}return!s.defaultPrevented}};or.FakeEventTarget=ts});var qi=x(dr=>{"use strict";Object.defineProperty(dr,"__esModule",{value:!0});dr.FakeHandler=void 0;var To=Ni(),xo=G(),ko=U(),lt=Ce(),rs=se(),Ai=W(),Do=ji(),B=new ko.Logger("FakeHandler"),Fi="FakeHandler",ss=class r extends xo.EnhancedEventEmitter{constructor({getSendExtendedRtpCapabilities:e},t){super();c(this,"_closed",!1);c(this,"_fakeParameters");c(this,"_getSendExtendedRtpCapabilities");c(this,"_cname",`CNAME-${lt.generateRandomNumber()}`);c(this,"_defaultSendStreamId",`${lt.generateRandomNumber()}`);c(this,"_transportReady",!1);c(this,"_nextLocalId",1);c(this,"_tracks",new Map);c(this,"_nextSctpStreamId",0);B.debug("constructor()"),this._getSendExtendedRtpCapabilities=e,this._fakeParameters=t}static createFactory(e){return{name:Fi,factory:t=>new r(t,e),getNativeRtpCapabilities:async()=>(B.debug("getNativeRtpCapabilities()"),r.getLocalRtpCapabilities(e)),getNativeSctpCapabilities:async()=>(B.debug("getNativeSctpCapabilities()"),e.generateNativeSctpCapabilities())}}static getLocalRtpCapabilities(e){let t=e.generateNativeRtpCapabilities();return rs.validateAndNormalizeRtpCapabilities(t),t}get name(){return Fi}close(){B.debug("close()"),!this._closed&&(this._closed=!0,super.close())}setIceGatheringState(e){this.emit("@icegatheringstatechange",e)}setConnectionState(e){this.emit("@connectionstatechange",e)}async updateIceServers(e){this.assertNotClosed(),B.debug("updateIceServers()")}async restartIce(e){this.assertNotClosed(),B.debug("restartIce()")}async getTransportStats(){return this.assertNotClosed(),new Map}async send({track:e,streamId:t,encodings:i,codecOptions:n,codec:a}){this.assertNotClosed(),B.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"});let o=r.getLocalRtpCapabilities(this._fakeParameters),l=this._getSendExtendedRtpCapabilities(o),u=rs.getSendingRtpParameters(e.kind,l);u.codecs=rs.reduceCodecs(u.codecs,a);let d=u.codecs.some(h=>/.+\/rtx$/i.test(h.mimeType));u.mid=`mid-${lt.generateRandomNumber()}`,u.msid=`${t??"-"} ${e.id}`,i||(i=[{}]);for(let h of i)h.ssrc=lt.generateRandomNumber(),d&&(h.rtx={ssrc:lt.generateRandomNumber()});u.encodings=i,u.rtcp={cname:this._cname,reducedSize:!0,mux:!0},u.msid=`${t??this._defaultSendStreamId} ${e.id}`;let p=this._nextLocalId++;return this._tracks.set(p,e),{localId:String(p),rtpParameters:u}}async stopSending(e){if(B.debug("stopSending() [localId:%s]",e),!this._closed){if(!this._tracks.has(Number(e)))throw new Error("local track not found");this._tracks.delete(Number(e))}}async pauseSending(e){this.assertNotClosed()}async resumeSending(e){this.assertNotClosed()}async replaceTrack(e,t){this.assertNotClosed(),t?B.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):B.debug("replaceTrack() [localId:%s, no track]",e),this._tracks.delete(Number(e)),this._tracks.set(Number(e),t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),B.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),B.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t)}async getSenderStats(e){return this.assertNotClosed(),new Map}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),B.debug("sendDataChannel()");let o=new cr({id:this._nextSctpStreamId++,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}),l={streamId:this._nextSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i};return{dataChannel:o,sctpStreamParameters:l}}async receive(e){this.assertNotClosed();let t=[];for(let i of e){let{trackId:n,kind:a}=i;this._transportReady||await this.setupTransport({localDtlsRole:"client"}),B.debug("receive() [trackId:%s, kind:%s]",n,a);let o=this._nextLocalId++,l=new To.FakeMediaStreamTrack({kind:a});this._tracks.set(o,l),t.push({localId:String(o),track:l})}return t}async stopReceiving(e){if(!this._closed)for(let t of e)B.debug("stopReceiving() [localId:%s]",t),this._tracks.delete(Number(t))}async pauseReceiving(e){this.assertNotClosed()}async resumeReceiving(e){this.assertNotClosed()}async getReceiverStats(e){return this.assertNotClosed(),new Map}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){return this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"client"}),B.debug("receiveDataChannel()"),{dataChannel:new cr({id:e.streamId,ordered:e.ordered,maxPacketLifeTime:e.maxPacketLifeTime,maxRetransmits:e.maxRetransmits,label:t,protocol:i})}}async setupTransport({localDtlsRole:e,localSdpObject:t}){let i=lt.clone(this._fakeParameters.generateLocalDtlsParameters());e&&(i.role=e),this.emit("@connectionstatechange","connecting"),await new Promise((n,a)=>this.emit("@connect",{dtlsParameters:i},n,a)),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Ai.InvalidStateError("method called in a closed handler")}};dr.FakeHandler=ss;var cr=class extends Do.FakeEventTarget{constructor({id:e,ordered:t=!0,maxPacketLifeTime:i=null,maxRetransmits:n=null,label:a="",protocol:o=""}){super();c(this,"_id");c(this,"_negotiated",!0);c(this,"_ordered");c(this,"_maxPacketLifeTime");c(this,"_maxRetransmits");c(this,"_label");c(this,"_protocol");c(this,"_readyState","connecting");c(this,"_bufferedAmount",0);c(this,"_bufferedAmountLowThreshold",0);c(this,"_binaryType","arraybuffer");c(this,"_onopen",null);c(this,"_onclosing",null);c(this,"_onclose",null);c(this,"_onmessage",null);c(this,"_onbufferedamountlow",null);c(this,"_onerror",null);B.debug(`constructor() [id:${e}, ordered:${t}, maxPacketLifeTime:${i}, maxRetransmits:${n}, label:${a}, protocol:${o}`),this._id=e,this._ordered=t,this._maxPacketLifeTime=i,this._maxRetransmits=n,this._label=a,this._protocol=o}get id(){return this._id}get negotiated(){return this._negotiated}get ordered(){return this._ordered}get maxPacketLifeTime(){return this._maxPacketLifeTime}get maxRetransmits(){return this._maxRetransmits}get label(){return this._label}get protocol(){return this._protocol}get readyState(){return this._readyState}get bufferedAmount(){return this._bufferedAmount}get bufferedAmountLowThreshold(){return this._bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._bufferedAmountLowThreshold=e}get binaryType(){return this._binaryType}set binaryType(e){this._binaryType=e}get onopen(){return this._onopen}set onopen(e){this._onopen&&this.removeEventListener("open",this._onopen),this._onopen=e,e&&this.addEventListener("open",e)}get onclosing(){return this._onclosing}set onclosing(e){this._onclosing&&this.removeEventListener("closing",this._onclosing),this._onclosing=e,e&&this.addEventListener("closing",e)}get onclose(){return this._onclose}set onclose(e){this._onclose&&this.removeEventListener("close",this._onclose),this._onclose=e,e&&this.addEventListener("close",e)}get onmessage(){return this._onmessage}set onmessage(e){this._onmessage&&this.removeEventListener("message",this._onmessage),this._onmessage=e,e&&this.addEventListener("message",e)}get onbufferedamountlow(){return this._onbufferedamountlow}set onbufferedamountlow(e){this._onbufferedamountlow&&this.removeEventListener("bufferedamountlow",this._onbufferedamountlow),this._onbufferedamountlow=e,e&&this.addEventListener("bufferedamountlow",e)}get onerror(){return this._onerror}set onerror(e){this._onerror&&this.removeEventListener("error",this._onerror),this._onerror=e,e&&this.addEventListener("error",e)}addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t,i){super.removeEventListener(e,t,i)}close(){["closing","closed"].includes(this._readyState)||(this._readyState="closed")}send(e){if(this._readyState!=="open")throw new Ai.InvalidStateError("not open")}}});var zi=x(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.generateRouterRtpCapabilities=Po;re.generateNativeRtpCapabilities=Lo;re.generateNativeSctpCapabilities=Io;re.generateLocalDtlsParameters=Mo;re.generateTransportRemoteParameters=Oo;re.generateProducerRemoteParameters=No;re.generateConsumerRemoteParameters=jo;re.generateDataProducerRemoteParameters=Fo;re.generateDataConsumerRemoteParameters=Ao;var V=Ce();function K(){return String(V.generateRandomNumber())}function Po(){return V.deepFreeze({codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}},{mimeType:"video/H264",kind:"video",preferredPayloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:105,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"profile-id":0,"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:106,clockRate:9e4,rtcpFeedback:[],parameters:{apt:105}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id",preferredId:2,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id",preferredId:3,preferredEncrypt:!1,direction:"recvonly"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:11,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:12,preferredEncrypt:!1,direction:"sendrecv"}]})}function Lo(){return{codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:111,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{minptime:10,useinbandfec:1}},{mimeType:"audio/ISAC",kind:"audio",preferredPayloadType:103,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/CN",kind:"audio",preferredPayloadType:106,clockRate:32e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/foo",kind:"audio",preferredPayloadType:107,clockRate:9e4,channels:4,rtcpFeedback:[{type:"foo-qwe-qwe"}],parameters:{foo:"lalala"}},{mimeType:"video/BAZCODEC",kind:"video",preferredPayloadType:100,clockRate:9e4,rtcpFeedback:[{type:"foo"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[],parameters:{apt:100}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:96,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:97,clockRate:9e4,rtcpFeedback:[],parameters:{apt:96}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:98,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{"profile-id":0}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:99,clockRate:9e4,rtcpFeedback:[],parameters:{apt:98}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:2},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:3},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:4},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay",preferredId:6},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type",preferredId:7},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing",preferredId:8},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10}]}}function Io(){return V.deepFreeze({numStreams:{OS:2048,MIS:2048}})}function Mo(){return V.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"82:5A:68:3D:36:C3:0A:DE:AF:E7:32:43:D2:88:83:57:AC:2D:65:E5:80:C4:B6:FB:AF:1A:A0:21:9F:6D:0C:AD"}],role:"auto"})}function Oo(){return{id:K(),iceParameters:V.deepFreeze({iceLite:!0,password:"yku5ej8nvfaor28lvtrabcx0wkrpkztz",usernameFragment:"h3hk1iz6qqlnqlne"}),iceCandidates:V.deepFreeze([{foundation:"udpcandidate",address:"9.9.9.9",ip:"9.9.9.9",port:40533,priority:1078862079,protocol:"udp",type:"host",tcpType:"passive"},{foundation:"udpcandidate",address:"9.9.9.9",ip:"9:9:9:9:9:9",port:41333,priority:1078862089,protocol:"udp",type:"host",tcpType:"passive"}]),dtlsParameters:V.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"A9:F4:E0:D2:74:D3:0F:D9:CA:A5:2F:9F:7F:47:FA:F0:C4:72:DD:73:49:D0:3B:14:90:20:51:30:1B:90:8E:71"},{algorithm:"sha-384",value:"03:D9:0B:87:13:98:F6:6D:BC:FC:92:2E:39:D4:E1:97:32:61:30:56:84:70:81:6E:D1:82:97:EA:D9:C1:21:0F:6B:C5:E7:7F:E1:97:0C:17:97:6E:CF:B3:EF:2E:74:B0"},{algorithm:"sha-512",value:"84:27:A4:28:A4:73:AF:43:02:2A:44:68:FF:2F:29:5C:3B:11:9A:60:F4:A8:F0:F5:AC:A0:E3:49:3E:B1:34:53:A9:85:CE:51:9B:ED:87:5E:B8:F4:8E:3D:FA:20:51:B8:96:EE:DA:56:DC:2F:5C:62:79:15:23:E0:21:82:2B:2C"}],role:"auto"}),sctpParameters:V.deepFreeze({port:5e3,OS:2048,MIS:2048,maxMessageSize:2e6})}}function No(){return V.deepFreeze({id:K()})}function jo({id:r,codecMimeType:s}={}){switch(s){case"audio/opus":return{id:r??K(),producerId:K(),kind:"audio",rtpParameters:V.deepFreeze({codecs:[{mimeType:"audio/opus",payloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}}],encodings:[{ssrc:46687003}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",id:10}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"audio/ISAC":return{id:r??K(),producerId:K(),kind:"audio",rtpParameters:V.deepFreeze({codecs:[{mimeType:"audio/ISAC",payloadType:111,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}}],encodings:[{ssrc:46687004}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/VP8":return{id:r??K(),producerId:K(),kind:"video",rtpParameters:V.deepFreeze({codecs:[{mimeType:"video/VP8",payloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",payloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}}],encodings:[{ssrc:99991111,rtx:{ssrc:99991112}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/H264":return{id:r??K(),producerId:K(),kind:"video",rtpParameters:V.deepFreeze({codecs:[{mimeType:"video/H264",payloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",payloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}}],encodings:[{ssrc:99991113,rtx:{ssrc:99991114}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};default:throw new TypeError(`unknown codecMimeType '${s}'`)}}function Fo(){return V.deepFreeze({id:K()})}function Ao({id:r}={}){return{id:r??K(),dataProducerId:K(),sctpStreamParameters:V.deepFreeze({streamId:666,maxPacketLifeTime:5e3,maxRetransmits:void 0})}}});var $i=x(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.debug=F.testFakeParameters=F.FakeHandler=F.enhancedEvents=F.ortc=F.parseScalabilityMode=F.detectDeviceAsync=F.detectDevice=F.Device=F.version=F.types=void 0;var qo=ut();F.debug=qo.default;F.types=us();F.version="3.18.3";var is=ki();Object.defineProperty(F,"Device",{enumerable:!0,get:function(){return is.Device}});Object.defineProperty(F,"detectDevice",{enumerable:!0,get:function(){return is.detectDevice}});Object.defineProperty(F,"detectDeviceAsync",{enumerable:!0,get:function(){return is.detectDeviceAsync}});var zo=xe();Object.defineProperty(F,"parseScalabilityMode",{enumerable:!0,get:function(){return zo.parse}});F.ortc=se();F.enhancedEvents=G();var $o=qi();Object.defineProperty(F,"FakeHandler",{enumerable:!0,get:function(){return $o.FakeHandler}});F.testFakeParameters=zi()});var Bo=Wi($i(),1);window.mediasoupClient=Bo;
